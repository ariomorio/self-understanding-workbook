<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒã‚¤ã‚³ãƒ³ãƒ‘</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .hero {
      text-align: center;
      padding: var(--spacing-xl) var(--spacing-md);
      background: linear-gradient(135deg, var(--primary-orange) 0%, var(--primary-yellow) 100%);
      border-radius: 0 0 30px 30px;
      margin-bottom: var(--spacing-lg);
    }
    .hero h1 {
      color: var(--white);
      font-size: 1.8rem;
      margin-bottom: var(--spacing-sm);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    .hero p {
      color: var(--white);
      opacity: 0.9;
    }
    .menu-section {
      margin-bottom: var(--spacing-lg);
    }
    .menu-section-title {
      color: var(--primary-brown);
      font-size: 1rem;
      margin-bottom: var(--spacing-sm);
      padding-left: var(--spacing-sm);
      border-left: 4px solid var(--primary-orange);
    }
    .menu-item .icon {
      font-size: 1.5rem;
    }
    .menu-item .desc {
      font-size: 0.85rem;
      color: var(--text-light);
    }
    .user-info {
      background: var(--white);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }
    .progress-overview {
      background: var(--white);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }
    .progress-bar-large {
      height: 12px;
      background: var(--gray-light);
      border-radius: 6px;
      overflow: hidden;
      margin-top: var(--spacing-sm);
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-orange), var(--primary-yellow));
      border-radius: 6px;
      transition: width 0.5s;
    }
    .progress-text {
      text-align: right;
      font-size: 0.9rem;
      color: var(--text-light);
      margin-top: var(--spacing-xs);
    }
    /* ãƒ­ã‚°ã‚¤ãƒ³/ç™»éŒ²ç”»é¢ */
    .login-screen {
      text-align: center;
      padding: var(--spacing-xl) var(--spacing-md);
    }
    .login-card {
      background: var(--white);
      padding: 40px 32px;
      border-radius: 16px;
      max-width: 400px;
      margin: 0 auto;
      box-shadow: var(--shadow-md);
    }
    .login-card h2 {
      color: var(--primary-brown);
      margin-bottom: var(--spacing-sm);
    }
    .login-card p {
      color: var(--text-light);
      font-size: 0.9rem;
      margin-bottom: var(--spacing-md);
      line-height: 1.6;
    }
    .form-group {
      margin-bottom: 16px;
      text-align: left;
    }
    .form-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: bold;
      color: var(--primary-brown);
      margin-bottom: 6px;
    }
    .form-group input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }
    .form-group input:focus {
      outline: none;
      border-color: var(--primary-orange);
    }
    .auth-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #ff9800, #ffc107);
      color: white;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 8px;
    }
    .auth-btn:hover {
      opacity: 0.9;
    }
    .auth-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .auth-switch {
      margin-top: 16px;
      font-size: 0.9rem;
      color: var(--text-light);
    }
    .auth-switch a {
      color: var(--primary-orange);
      text-decoration: none;
      font-weight: bold;
      cursor: pointer;
    }
    .auth-switch a:hover {
      text-decoration: underline;
    }
    .auth-error {
      background: #fff0f0;
      border: 1px solid #ffcdd2;
      color: #c62828;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.85rem;
      margin-bottom: 16px;
      display: none;
    }
    .auth-success {
      background: #e8f5e9;
      border: 1px solid #c8e6c9;
      color: #2e7d32;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.85rem;
      margin-bottom: 16px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="hero">
    <h1>ãƒã‚¤ã‚³ãƒ³ãƒ‘</h1>
    <p>-è¿·ã‚ãªã„è‡ªåˆ†ã®ä½œã‚Šæ–¹-</p>
  </div>

  <div class="container">
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ï¼ˆæœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ï¼‰ -->
    <div id="loginScreen" class="login-screen">
      <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div id="loginForm" class="login-card">
        <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
        <p>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§<br>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
        <div id="loginError" class="auth-error"></div>
        <div class="form-group">
          <label for="loginEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input type="email" id="loginEmail" placeholder="example@mail.com" autocomplete="email">
        </div>
        <div class="form-group">
          <label for="loginPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="password" id="loginPassword" placeholder="6æ–‡å­—ä»¥ä¸Š" autocomplete="current-password">
        </div>
        <button id="loginBtn" class="auth-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <div class="auth-switch">
          ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„æ–¹ã¯<br><a id="showRegister">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</a>
        </div>
      </div>

      <!-- ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div id="registerForm" class="login-card" style="display: none;">
        <h2>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</h2>
        <p>æ–°ã—ã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦<br>è‡ªå·±ç†è§£ãƒ¯ãƒ¼ã‚¯ã‚’å§‹ã‚ã¾ã—ã‚‡ã†</p>
        <div id="registerError" class="auth-error"></div>
        <div id="registerSuccess" class="auth-success"></div>
        <div class="form-group">
          <label for="registerName">ãŠåå‰</label>
          <input type="text" id="registerName" placeholder="å±±ç”° å¤ªéƒ" autocomplete="name">
        </div>
        <div class="form-group">
          <label for="registerEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input type="email" id="registerEmail" placeholder="example@mail.com" autocomplete="email">
        </div>
        <div class="form-group">
          <label for="registerPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="password" id="registerPassword" placeholder="6æ–‡å­—ä»¥ä¸Š" autocomplete="new-password">
        </div>
        <button id="registerBtn" class="auth-btn">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</button>
        <div class="auth-switch">
          æ—¢ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®æ–¹ã¯<br><a id="showLogin">ãƒ­ã‚°ã‚¤ãƒ³ã«æˆ»ã‚‹</a>
        </div>
      </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œï¼‰ -->
    <div id="mainContent" style="display: none;">
      <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± -->
      <div class="user-info" id="userInfoSection">
        <div style="display: flex; align-items: center; gap: 12px;">
          <div id="userAvatarWrap" style="position:relative; width:48px; height:48px; cursor:pointer;" onclick="openAvatarPicker()"><div style="width:48px; height:48px; border-radius:50%; background:linear-gradient(135deg, #ff9800, #ffc107); display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:1.2rem; overflow:hidden;" id="userInitial"></div><div style="position:absolute; bottom:-2px; right:-2px; width:18px; height:18px; border-radius:50%; background:#4caf50; color:white; font-size:0.65rem; display:flex; align-items:center; justify-content:center; border:2px solid white;">âœ</div></div>
          <div style="flex: 1;">
            <div id="userDisplayName" style="font-weight: bold; color: var(--primary-brown);"></div>
            <div id="userEmail" style="font-size: 0.85rem; color: var(--text-light);"></div>
          </div>
          <button id="logoutBtn" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-size: 0.85rem;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </div>
<!-- äººç”Ÿèª¬æ˜æ›¸ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ãƒªãƒ³ã‚¯ -->      <a href="pages/my-compass.html" id="compassLink" style="display:none; margin-top:12px; padding:16px; background:linear-gradient(135deg, #ffd93d, #f5a623); border-radius:12px; text-decoration:none; color:#8b5a2b; text-align:center; box-shadow:0 2px 8px rgba(245,166,35,0.3);">        <div style="font-size:1.5rem; margin-bottom:4px;">ğŸ“–</div>        <div style="font-weight:bold; font-size:1rem;">ã‚ãªãŸã®äººç”Ÿèª¬æ˜æ›¸ã‚’è¦‹ã‚‹</div>        <div style="font-size:0.8rem; opacity:0.8; margin-top:4px;">å®Œæˆã—ãŸèª¬æ˜æ›¸ã‚’ã‚¹ãƒãƒ›å£ç´™ã«ä¿å­˜ã§ãã¾ã™</div>      </a>

      <!-- é€²æ—çŠ¶æ³ -->
      <div class="progress-overview">
        <strong>å…¨ä½“ã®é€²æ—</strong>
        <div class="progress-bar-large">
          <div class="progress-bar-fill" id="totalProgress" style="width: 0%"></div>
        </div>
        <div class="progress-text"><span id="progressPercent">0</span>% å®Œäº†</div>
      </div>

      <!-- ã‚¬ã‚¤ãƒ‰ -->
      <div class="menu-section">
        <div class="menu-section-title">ã¯ã˜ã‚ã«</div>
        <div class="menu-grid">
          <a href="pages/01-osaru-ai.html" class="menu-item" data-page="osaru-ai">
            <div class="number">0</div>
            <div>
              <div class="title">ãŠã•ã‚‹AI</div>
              <div class="desc">24æ™‚é–“ã‚³ãƒ¼ãƒãƒ³ã‚°AIã®ç´¹ä»‹</div>
            </div>
            <div class="status" id="status-osaru-ai"></div>
          </a>
          <a href="pages/02-about.html" class="menu-item" data-page="about">
            <div class="number">0</div>
            <div>
              <div class="title">è‡ªå·±ç†è§£ã¨ã¯</div>
              <div class="desc">ãªãœè‡ªå·±ç†è§£ãŒå¿…è¦ãªã®ã‹ï¼Ÿ</div>
            </div>
            <div class="status" id="status-about"></div>
          </a>
        </div>
      </div>

      <!-- è¨ºæ–­ -->
      <div class="menu-section">
        <div class="menu-section-title">æ€§æ ¼è¨ºæ–­</div>
        <div class="menu-grid">
          <a href="pages/03-personality.html" class="menu-item" data-page="personality">
            <div class="number">1</div>
            <div>
              <div class="title">æ€§æ ¼è¨ºæ–­ãƒ¯ãƒ¼ã‚¯</div>
              <div class="desc">ã†ã•ã/ã‹ã‚ Ã— ã‚¢ãƒª/ã‚­ãƒªã‚®ãƒªã‚¹</div>
            </div>
            <div class="status" id="status-personality"></div>
          </a>
        </div>
      </div>

      <!-- è‡ªå·±ç†è§£ãƒ¯ãƒ¼ã‚¯ -->
      <div class="menu-section">
        <div class="menu-section-title">è‡ªå·±ç†è§£ãƒ¯ãƒ¼ã‚¯</div>
        <div class="menu-grid">
          <a href="pages/04-values.html" class="menu-item" data-page="values">
            <div class="number">2</div>
            <div>
              <div class="title">ä¾¡å€¤è¦³ãƒ¯ãƒ¼ã‚¯</div>
              <div class="desc">ä½•ã‚’å¤§åˆ‡ã«ã—ãŸã„ã‹</div>
            </div>
            <div class="status" id="status-values"></div>
          </a>
          <a href="pages/05-talent.html" class="menu-item" data-page="talent">
            <div class="number">3</div>
            <div>
              <div class="title">æ‰èƒ½ãƒ¯ãƒ¼ã‚¯</div>
              <div class="desc">ç„¡æ„è­˜ã«ã§ãã‚‹å¼·ã¿</div>
            </div>
            <div class="status" id="status-talent"></div>
          </a>
          <a href="pages/06-passion.html" class="menu-item" data-page="passion">
            <div class="number">4</div>
            <div>
              <div class="title">æƒ…ç†±ãƒ¯ãƒ¼ã‚¯</div>
              <div class="desc">é ‘å¼µã‚‰ãªãã¦ã‚‚é ‘å¼µã‚Œã‚‹ã“ã¨</div>
            </div>
            <div class="status" id="status-passion"></div>
          </a>
          <a href="pages/07-mission.html" class="menu-item" data-page="mission">
            <div class="number">5</div>
            <div>
              <div class="title">ä½¿å‘½ãƒ»åˆ¤æ–­è»¸ãƒ¯ãƒ¼ã‚¯</div>
              <div class="desc">äººç”Ÿã®ç›®çš„ã‚’è¦‹ã¤ã‘ã‚‹</div>
            </div>
            <div class="status" id="status-mission"></div>
          </a>
        </div>
      </div>

      <!-- ã¾ã¨ã‚ -->
      <div class="menu-section">
        <div class="menu-section-title">ã¾ã¨ã‚</div>
        <div class="menu-grid">
          <a href="pages/08-become.html" class="menu-item" data-page="become">
            <div class="number">6</div>
            <div>
              <div class="title">ãªã‚ŠãŸã„è‡ªåˆ†ãƒ¯ãƒ¼ã‚¯</div>
              <div class="desc">5å¹´å¾Œã€œåŠå¹´å¾Œã®ç›®æ¨™è¨­å®š</div>
            </div>
            <div class="status" id="status-become"></div>
          </a>
          <a href="pages/09-life-manual.html" class="menu-item" data-page="life-manual">
            <div class="number">7</div>
            <div>
              <div class="title">äººç”Ÿã®èª¬æ˜æ›¸</div>
              <div class="desc">ã™ã¹ã¦ã‚’ã¾ã¨ã‚ãŸè‡ªåˆ†ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</div>
            </div>
            <div class="status" id="status-life-manual"></div>
          </a>
        </div>
      </div>

      <!-- AIåˆ†æ -->
      <div class="menu-section">
        <div class="menu-section-title">AIåˆ†æ</div>
        <div class="menu-grid">
          <a href="pages/10-ai-analysis.html" class="menu-item" data-page="ai-analysis">
            <div class="number" style="background: var(--primary-green);">AI</div>
            <div>
              <div class="title">AIè‡ªå·±åˆ†æ</div>
              <div class="desc">å…¥åŠ›å†…å®¹ã‚’AIãŒç·åˆåˆ†æ</div>
            </div>
            <div class="status" id="status-ai-analysis"></div>
          </a>
        </div>
      </div>

      <!-- ç®¡ç†ï¼ˆç®¡ç†è€…ã®ã¿è¡¨ç¤ºï¼‰ -->
      <div class="menu-section" id="adminSection" style="display:none;">
        <div class="menu-section-title">ç®¡ç†</div>
        <div class="menu-grid">
          <a href="pages/admin.html" class="menu-item">
            <div class="number" style="background: #546e7a;">&#9881;</div>
            <div>
              <div class="title">ç®¡ç†ç”»é¢</div>
              <div class="desc">AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š</div>
            </div>
          </a>
        </div>
      </div>
    </div>
<div style="text-align: center; margin-top: var(--spacing-lg);">      <a href="pages/admin-login.html" style="color: var(--text-light); font-size: 0.85rem; text-decoration: none;">ã‚³ãƒ¼ãƒã®æ–¹ã¯ã“ã¡ã‚‰</a>    </div>
  </div>

  <!-- Lark APIé€£æº -->
  <script src="js/lark-api.js"></script>
  <script src="js/lark-config.js"></script>
  <script src="js/data-sync.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆ
      checkLogin();

      // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®è‡ªå‹•åŒæœŸï¼ˆLark Baseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å¾©å…ƒï¼‰
      const needSync = localStorage.getItem('selfUnderstanding_needSync');
      if (needSync === 'true') {
        localStorage.removeItem('selfUnderstanding_needSync');
        setTimeout(async () => {
          try {
            showSyncingOverlay(true);
            // DataSyncãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã‘ã‚Œã°æ‰‹å‹•ã§åˆæœŸåŒ–
            if (window.DataSync) {
              if (!window.DataSync.userId) window.DataSync.init();
              await window.DataSync.syncOnLogin();
            }
            updateProgress();
          } catch (error) {
            console.error('Auto sync failed:', error);
          } finally {
            showSyncingOverlay(false);
          }
        }, 500);
      }

      // é€²æ—çŠ¶æ³ã‚’æ›´æ–°
      updateProgress();

      // ãƒ•ã‚©ãƒ¼ãƒ åˆ‡ã‚Šæ›¿ãˆ
      document.getElementById('showRegister').addEventListener('click', function() {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('registerForm').style.display = 'block';
        clearErrors();
      });

      document.getElementById('showLogin').addEventListener('click', function() {
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('loginForm').style.display = 'block';
        clearErrors();
      });

      // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
      // Enterã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
      document.getElementById('loginPassword').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') handleLogin();
      });

      // ç™»éŒ²ãƒœã‚¿ãƒ³
      document.getElementById('registerBtn').addEventListener('click', handleRegister);
      // Enterã‚­ãƒ¼ã§ç™»éŒ²
      document.getElementById('registerPassword').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') handleRegister();
      });

      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³
      document.getElementById('logoutBtn').addEventListener('click', function() {
        localStorage.removeItem('selfUnderstanding_larkUser');
        localStorage.removeItem('selfUnderstanding_userId');
        localStorage.removeItem('selfUnderstanding_userName');
        checkLogin();
      });
    });

    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    async function handleLogin() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');
      const btn = document.getElementById('loginBtn');

      errorEl.style.display = 'none';

      if (!email || !password) {
        errorEl.textContent = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        errorEl.style.display = 'block';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';

      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (!response.ok) {
          errorEl.textContent = data.error || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ';
          errorEl.style.display = 'block';
          return;
        }

        // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ - ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’localStorageã«ä¿å­˜
        const userData = {
          userId: data.userId,
          avatar: data.avatar || "",
          name: data.name,
          email: data.email,
          loginAt: new Date().toISOString()
        };
        localStorage.setItem('selfUnderstanding_larkUser', JSON.stringify(userData));
        localStorage.setItem('selfUnderstanding_userId', userData.userId);
        localStorage.setItem('selfUnderstanding_userName', userData.name);
        localStorage.setItem('selfUnderstanding_needSync', 'true');

        // ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ã§åŒæœŸã‚’é–‹å§‹
        window.location.reload();

      } catch (error) {
        errorEl.textContent = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        errorEl.style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
      }
    }

    // ç™»éŒ²å‡¦ç†
    async function handleRegister() {
      const name = document.getElementById('registerName').value.trim();
      const email = document.getElementById('registerEmail').value.trim();
      const password = document.getElementById('registerPassword').value;
      const errorEl = document.getElementById('registerError');
      const successEl = document.getElementById('registerSuccess');
      const btn = document.getElementById('registerBtn');

      errorEl.style.display = 'none';
      successEl.style.display = 'none';

      if (!name || !email || !password) {
        errorEl.textContent = 'å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        errorEl.style.display = 'block';
        return;
      }

      if (password.length < 6) {
        errorEl.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„';
        errorEl.style.display = 'block';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'ç™»éŒ²ä¸­...';

      try {
        const response = await fetch('/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, name, password })
        });

        const data = await response.json();

        if (!response.ok) {
          errorEl.textContent = data.error || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ';
          errorEl.style.display = 'block';
          return;
        }

        // ç™»éŒ²æˆåŠŸ
        successEl.textContent = 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';
        successEl.style.display = 'block';

        // 2ç§’å¾Œã«ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã«åˆ‡ã‚Šæ›¿ãˆï¼ˆãƒ¡ãƒ¼ãƒ«ã‚’è‡ªå‹•å…¥åŠ›ï¼‰
        setTimeout(() => {
          document.getElementById('registerForm').style.display = 'none';
          document.getElementById('loginForm').style.display = 'block';
          document.getElementById('loginEmail').value = email;
          document.getElementById('loginPassword').focus();
          clearErrors();
        }, 2000);

      } catch (error) {
        errorEl.textContent = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        errorEl.style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.textContent = 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ';
      }
    }

    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
    function clearErrors() {
      document.getElementById('loginError').style.display = 'none';
      document.getElementById('registerError').style.display = 'none';
      document.getElementById('registerSuccess').style.display = 'none';
    }

    // åŒæœŸä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º
    function showSyncingOverlay(show) {
      let overlay = document.getElementById('syncingOverlay');
      if (show) {
        if (!overlay) {
          overlay = document.createElement('div');
          overlay.id = 'syncingOverlay';
          overlay.innerHTML = `
            <div style="background: white; padding: 32px 48px; border-radius: 16px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
              <div style="width: 48px; height: 48px; border: 4px solid #f0f0f0; border-top-color: #ff9800; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
              <p style="margin: 0; font-weight: bold; color: #333;">ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸä¸­...</p>
              <p style="margin: 8px 0 0; font-size: 0.9rem; color: #666;">ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã¾ã™</p>
            </div>
          `;
          Object.assign(overlay.style, {
            position: 'fixed',
            top: '0',
            left: '0',
            right: '0',
            bottom: '0',
            background: 'rgba(0,0,0,0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: '10000'
          });
          const style = document.createElement('style');
          style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
          document.head.appendChild(style);
          document.body.appendChild(overlay);
        }
        overlay.style.display = 'flex';
      } else if (overlay) {
        overlay.style.display = 'none';
      }
    }

    // ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ãƒªã‚¹ãƒˆ
    // ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯ï¼ˆAPIçµŒç”±ã§Lark Baseè¨­å®šã‚’å‚ç…§ï¼‰
    async function checkAdminAccess(email) {
      try {
        const res = await fetch(`/api/admin-check?email=${encodeURIComponent(email)}`);
        const data = await res.json();
        return data.isAdmin === true;
      } catch { return false; }
    }

    // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ â†’ ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
    function checkLogin() {
      const storedUser = localStorage.getItem('selfUnderstanding_larkUser');
      const loginScreen = document.getElementById('loginScreen');
      const mainContent = document.getElementById('mainContent');

      if (storedUser) {
        const user = JSON.parse(storedUser);
        document.getElementById('userDisplayName').textContent = user.name;
        document.getElementById('userEmail').textContent = user.email || user.userId;

        // ã‚¤ãƒ‹ã‚·ãƒ£ãƒ«ã‚¢ã‚¤ã‚³ãƒ³
        const initial = (user.name || '?').charAt(0).toUpperCase();
        document.getElementById('userInitial').textContent = initial;
// ã‚¢ãƒã‚¿ãƒ¼è¡¨ç¤º        if (user.avatar) {          displayAvatar(user.avatar);        }

        loginScreen.style.display = 'none';
        mainContent.style.display = 'block';

        // ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯ï¼ˆéåŒæœŸï¼‰
        const adminSection = document.getElementById('adminSection');
        if (adminSection) {
          adminSection.style.display = 'none';
          checkAdminAccess(user.email).then(isAdmin => {
            adminSection.style.display = isAdmin ? '' : 'none';
          });
        }
        // äººç”Ÿèª¬æ˜æ›¸ãƒªãƒ³ã‚¯ã®è¡¨ç¤ºãƒã‚§ãƒƒã‚¯
        var compassLink = document.getElementById("compassLink");
        if (compassLink) {
          var lifeManual = localStorage.getItem("selfUnderstanding_life-manual");
          if (lifeManual) {
            try {
              var lmData = JSON.parse(lifeManual);
              compassLink.style.display = (lmData.finalManual && lmData.finalManual.trim()) ? "block" : "none";
            } catch(e) { compassLink.style.display = "none"; }
          } else {
            compassLink.style.display = "none";
          }
        }
      } else {
        loginScreen.style.display = 'block';
        mainContent.style.display = 'none';
      }
    }

    // é€²æ—çŠ¶æ³ã‚’æ›´æ–°
    function updateProgress() {
      const pages = ['osaru-ai', 'about', 'personality', 'values', 'talent', 'passion', 'mission', 'become', 'life-manual'];
      let completed = 0;

      pages.forEach(page => {
        const data = localStorage.getItem(`selfUnderstanding_${page}`);
        const statusEl = document.getElementById(`status-${page}`);
        if (data) {
          completed++;
          if (statusEl) statusEl.textContent = '\u2705';
          const menuItem = document.querySelector(`[data-page="${page}"]`);
          if (menuItem) menuItem.classList.add('completed');
        }
      });

      const percent = Math.round((completed / pages.length) * 100);
      document.getElementById('totalProgress').style.width = percent + '%';
      document.getElementById('progressPercent').textContent = percent;
    }
    // â”€â”€ ã‚¢ãƒã‚¿ãƒ¼æ©Ÿèƒ½ â”€â”€
    const AVATAR_EMOJIS = ["ğŸµ","ğŸ¶","ğŸ±","ğŸ°","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¨","ğŸ¦","ğŸ¯","ğŸ¸","ğŸ§","ğŸ¦","ğŸ¦„","ğŸ","ğŸŒ¸","ğŸŒ»","ğŸŒº","ğŸ€","ğŸŒˆ","â­","ğŸŒ™","ğŸ”¥","ğŸ’","ğŸµ","ğŸ¨","ğŸ“š","âœ¨","ğŸ’¡","ğŸš€","ğŸ¯","ğŸ†","ğŸ’ª","ğŸŒŠ","ğŸ","ğŸŒ¿"];

    function openAvatarPicker() {
      var modal = document.getElementById("avatarModal");
      var grid = document.getElementById("avatarGrid");
      grid.innerHTML = "";
      AVATAR_EMOJIS.forEach(function(emoji) {
        var btn = document.createElement("button");
        btn.textContent = emoji;
        btn.style.cssText = "font-size:2rem; width:48px; height:48px; border:2px solid transparent; border-radius:12px; background:none; cursor:pointer; transition:all 0.2s;";
        btn.onmouseover = function(){ this.style.borderColor = "#ffc107"; this.style.background = "#fff8e1"; };
        btn.onmouseout = function(){ this.style.borderColor = "transparent"; this.style.background = "none"; };
        btn.onclick = function(){ selectAvatar(emoji); };
        grid.appendChild(btn);
      });
      modal.style.display = "flex";
    }

    function closeAvatarPicker() {
      document.getElementById("avatarModal").style.display = "none";
    }

    function selectAvatar(emoji) {
      var stored = localStorage.getItem("selfUnderstanding_larkUser");
      if (stored) {
        var user = JSON.parse(stored);
        user.avatar = emoji;
        localStorage.setItem("selfUnderstanding_larkUser", JSON.stringify(user));
        displayAvatar(emoji);
        saveAvatarToLark(user.userId, emoji);
      }
      closeAvatarPicker();
    }

    function clearAvatar() {
      var stored = localStorage.getItem("selfUnderstanding_larkUser");
      if (stored) {
        var user = JSON.parse(stored);
        user.avatar = "";
        localStorage.setItem("selfUnderstanding_larkUser", JSON.stringify(user));
        var initial = (user.name || "?").charAt(0).toUpperCase();
        document.getElementById("userInitial").innerHTML = initial;
        document.getElementById("userInitial").style.fontSize = "1.2rem";
        saveAvatarToLark(user.userId, "");
      }
      closeAvatarPicker();
    }

    function displayAvatar(avatar) {
      var el = document.getElementById("userInitial");
      if (avatar) {
        el.innerHTML = avatar;
        el.style.fontSize = "1.8rem";
      }
    }

    async function saveAvatarToLark(userId, avatar) {
      try {
        var response = await fetch("/api/auth/update-avatar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: userId, avatar: avatar })
        });
        if (!response.ok) console.error("Avatar save failed");
      } catch (e) {
        console.error("Avatar save error:", e);
      }
    }
  </script>
<!-- ã‚¢ãƒã‚¿ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="avatarModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; display:none; align-items:center; justify-content:center;">
  <div style="background:white; border-radius:16px; padding:24px; max-width:340px; width:90%; max-height:70vh; overflow-y:auto;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <h3 style="margin:0; color:#8b5a2b;">ã‚¢ã‚¤ã‚³ãƒ³ã‚’é¸æŠ</h3>
      <button onclick="closeAvatarPicker()" style="border:none; background:none; font-size:1.5rem; cursor:pointer; color:#999;">u00d7</button>
    </div>
    <div id="avatarGrid" style="display:grid; grid-template-columns:repeat(6, 1fr); gap:8px;"></div>
    <div style="margin-top:16px; text-align:center;">
      <button onclick="clearAvatar()" style="padding:8px 20px; border:1px solid #ddd; border-radius:8px; background:white; cursor:pointer; font-size:0.85rem; color:#999;">ã‚¤ãƒ‹ã‚·ãƒ£ãƒ«ã«æˆ»ã™</button>
    </div>
  </div>
</div>
</body>
</html>
