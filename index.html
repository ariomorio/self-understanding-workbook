<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>自己理解の教科書</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .hero {
      text-align: center;
      padding: var(--spacing-xl) var(--spacing-md);
      background: linear-gradient(135deg, var(--primary-orange) 0%, var(--primary-yellow) 100%);
      border-radius: 0 0 30px 30px;
      margin-bottom: var(--spacing-lg);
    }
    .hero h1 {
      color: var(--white);
      font-size: 1.8rem;
      margin-bottom: var(--spacing-sm);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    .hero p {
      color: var(--white);
      opacity: 0.9;
    }
    .menu-section {
      margin-bottom: var(--spacing-lg);
    }
    .menu-section-title {
      color: var(--primary-brown);
      font-size: 1rem;
      margin-bottom: var(--spacing-sm);
      padding-left: var(--spacing-sm);
      border-left: 4px solid var(--primary-orange);
    }
    .menu-item .icon {
      font-size: 1.5rem;
    }
    .menu-item .desc {
      font-size: 0.85rem;
      color: var(--text-light);
    }
    .user-info {
      background: var(--white);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }
    .user-info input {
      width: 100%;
      padding: var(--spacing-sm);
      border: 2px solid #e0e0e0;
      border-radius: var(--radius-sm);
      font-size: 1rem;
      margin-top: var(--spacing-xs);
    }
    .user-info input:focus {
      outline: none;
      border-color: var(--primary-orange);
    }
    .progress-overview {
      background: var(--white);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }
    .progress-bar-large {
      height: 12px;
      background: var(--gray-light);
      border-radius: 6px;
      overflow: hidden;
      margin-top: var(--spacing-sm);
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-orange), var(--primary-yellow));
      border-radius: 6px;
      transition: width 0.5s;
    }
    .progress-text {
      text-align: right;
      font-size: 0.9rem;
      color: var(--text-light);
      margin-top: var(--spacing-xs);
    }
  </style>
</head>
<body>
  <div class="hero">
    <h1>自己理解の教科書</h1>
    <p>あなたらしい人生を歩むための<br>自己理解ワークブック</p>
  </div>

  <div class="container">
    <!-- Larkログイン -->
    <div class="user-info" id="larkLoginSection">
      <div id="loggedOutView">
        <p style="margin-bottom: var(--spacing-sm); color: var(--text-light);">Larkアカウントでログインすると、データがクラウドに自動保存されます</p>
        <button id="larkLoginBtn" style="width: 100%; padding: 12px; border: none; border-radius: 8px; background: linear-gradient(135deg, #3370ff, #2558d9); color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18l6.9 3.45L12 11.08 5.1 7.63 12 4.18zM4 8.82l7 3.5v7.36l-7-3.5V8.82zm9 10.86v-7.36l7-3.5v7.36l-7 3.5z"/></svg>
          Larkでログイン
        </button>
      </div>
      <div id="loggedInView" style="display: none;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <img id="userAvatar" src="" alt="" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
          <div style="flex: 1;">
            <div id="userDisplayName" style="font-weight: bold; color: var(--primary-brown);"></div>
            <div id="userEmail" style="font-size: 0.85rem; color: var(--text-light);"></div>
          </div>
          <button id="logoutBtn" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-size: 0.85rem;">ログアウト</button>
        </div>
      </div>
    </div>

    <!-- ユーザー情報（ログインしていない場合） -->
    <div class="user-info" id="manualUserSection" style="display: none;">
      <label for="userName">あなたのお名前（ニックネーム可）</label>
      <input type="text" id="userName" placeholder="例：たろう" />
    </div>

    <!-- 進捗状況 -->
    <div class="progress-overview">
      <strong>全体の進捗</strong>
      <div class="progress-bar-large">
        <div class="progress-bar-fill" id="totalProgress" style="width: 0%"></div>
      </div>
      <div class="progress-text"><span id="progressPercent">0</span>% 完了</div>
    </div>

    <!-- クラウド同期 -->
    <div class="cloud-sync" style="background: var(--white); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-lg); box-shadow: var(--shadow-sm);">
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: var(--spacing-sm);">
        <span style="font-size: 1.2rem;">☁️</span>
        <strong>Lark Base連携</strong>
      </div>
      <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: var(--spacing-sm);">
        データをクラウドに保存して、どの端末からでもアクセス
      </p>
      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        <button id="syncToCloud" style="flex: 1; min-width: 120px; padding: 10px; border: none; border-radius: 6px; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; font-weight: bold; cursor: pointer;">
          クラウドに同期
        </button>
        <button id="restoreFromCloud" style="flex: 1; min-width: 120px; padding: 10px; border: none; border-radius: 6px; background: linear-gradient(135deg, #2196F3, #1976D2); color: white; font-weight: bold; cursor: pointer;">
          クラウドから復元
        </button>
        <button id="openLarkBase" style="flex: 1; min-width: 120px; padding: 10px; border: none; border-radius: 6px; background: linear-gradient(135deg, #FF9800, #F57C00); color: white; font-weight: bold; cursor: pointer;">
          Baseを開く
        </button>
      </div>
    </div>

    <!-- ガイド -->
    <div class="menu-section">
      <div class="menu-section-title">はじめに</div>
      <div class="menu-grid">
        <a href="pages/01-osaru-ai.html" class="menu-item" data-page="osaru-ai">
          <div class="number">0</div>
          <div>
            <div class="title">おさるAI</div>
            <div class="desc">24時間コーチングAIの紹介</div>
          </div>
          <div class="status" id="status-osaru-ai"></div>
        </a>
        <a href="pages/02-about.html" class="menu-item" data-page="about">
          <div class="number">0</div>
          <div>
            <div class="title">自己理解とは</div>
            <div class="desc">なぜ自己理解が必要なのか？</div>
          </div>
          <div class="status" id="status-about"></div>
        </a>
      </div>
    </div>

    <!-- 診断 -->
    <div class="menu-section">
      <div class="menu-section-title">性格診断</div>
      <div class="menu-grid">
        <a href="pages/03-personality.html" class="menu-item" data-page="personality">
          <div class="number">1</div>
          <div>
            <div class="title">性格診断ワーク</div>
            <div class="desc">うさぎ/かめ × アリ/キリギリス</div>
          </div>
          <div class="status" id="status-personality"></div>
        </a>
      </div>
    </div>

    <!-- 自己理解ワーク -->
    <div class="menu-section">
      <div class="menu-section-title">自己理解ワーク</div>
      <div class="menu-grid">
        <a href="pages/04-values.html" class="menu-item" data-page="values">
          <div class="number">2</div>
          <div>
            <div class="title">価値観ワーク</div>
            <div class="desc">何を大切にしたいか</div>
          </div>
          <div class="status" id="status-values"></div>
        </a>
        <a href="pages/05-talent.html" class="menu-item" data-page="talent">
          <div class="number">3</div>
          <div>
            <div class="title">才能ワーク</div>
            <div class="desc">無意識にできる強み</div>
          </div>
          <div class="status" id="status-talent"></div>
        </a>
        <a href="pages/06-passion.html" class="menu-item" data-page="passion">
          <div class="number">4</div>
          <div>
            <div class="title">情熱ワーク</div>
            <div class="desc">頑張らなくても頑張れること</div>
          </div>
          <div class="status" id="status-passion"></div>
        </a>
        <a href="pages/07-mission.html" class="menu-item" data-page="mission">
          <div class="number">5</div>
          <div>
            <div class="title">使命・判断軸ワーク</div>
            <div class="desc">人生の目的を見つける</div>
          </div>
          <div class="status" id="status-mission"></div>
        </a>
      </div>
    </div>

    <!-- まとめ -->
    <div class="menu-section">
      <div class="menu-section-title">まとめ</div>
      <div class="menu-grid">
        <a href="pages/08-become.html" class="menu-item" data-page="become">
          <div class="number">6</div>
          <div>
            <div class="title">なりたい自分ワーク</div>
            <div class="desc">5年後〜半年後の目標設定</div>
          </div>
          <div class="status" id="status-become"></div>
        </a>
        <a href="pages/09-life-manual.html" class="menu-item" data-page="life-manual">
          <div class="number">7</div>
          <div>
            <div class="title">人生の説明書</div>
            <div class="desc">すべてをまとめた自分マニュアル</div>
          </div>
          <div class="status" id="status-life-manual"></div>
        </a>
      </div>
    </div>

    <!-- AI分析 -->
    <div class="menu-section">
      <div class="menu-section-title">AI分析</div>
      <div class="menu-grid">
        <a href="pages/10-ai-analysis.html" class="menu-item" data-page="ai-analysis">
          <div class="number" style="background: var(--primary-green);">AI</div>
          <div>
            <div class="title">AI自己分析</div>
            <div class="desc">入力内容をAIが総合分析</div>
          </div>
          <div class="status" id="status-ai-analysis"></div>
        </a>
      </div>
    </div>

  </div>

  <!-- Lark API連携 -->
  <script src="js/lark-api.js"></script>
  <script src="js/lark-config.js"></script>
  <script src="js/data-sync.js"></script>

  <script>
    // ローカルストレージからユーザー名を読み込み
    document.addEventListener('DOMContentLoaded', function() {
      // Larkユーザー情報をチェック
      checkLarkLogin();

      // ログイン後の自動同期
      const needSync = localStorage.getItem('selfUnderstanding_needSync');
      if (needSync === 'true') {
        localStorage.removeItem('selfUnderstanding_needSync');
        // DataSyncの初期化を待ってから同期
        setTimeout(async () => {
          if (window.DataSync && window.LarkAPI) {
            try {
              showSyncingOverlay(true);
              await window.DataSync.syncOnLogin();
              updateProgress(); // 進捗を更新
            } catch (error) {
              console.error('Auto sync failed:', error);
            } finally {
              showSyncingOverlay(false);
            }
          }
        }, 1000);
      }

      const userName = localStorage.getItem('selfUnderstanding_userName');
      if (userName) {
        const userNameInput = document.getElementById('userName');
        if (userNameInput) userNameInput.value = userName;
      }

      // 進捗状況を更新
      updateProgress();

      // Larkログインボタン
      document.getElementById('larkLoginBtn').addEventListener('click', async function() {
        try {
          const response = await fetch('/api/auth/login');
          const data = await response.json();
          window.location.href = data.url;
        } catch (error) {
          alert('ログインURLの取得に失敗しました');
        }
      });

      // ログアウトボタン
      document.getElementById('logoutBtn').addEventListener('click', function() {
        localStorage.removeItem('selfUnderstanding_larkUser');
        localStorage.removeItem('selfUnderstanding_userId');
        checkLarkLogin();
      });

      // 同期ボタンのイベント
      document.getElementById('syncToCloud').addEventListener('click', async function() {
        this.disabled = true;
        this.textContent = '同期中...';
        try {
          await window.DataSync.syncAllToLarkBase();
        } catch (error) {
          console.error('Sync failed:', error);
          alert('同期に失敗しました: ' + error.message);
        }
        this.disabled = false;
        this.textContent = 'クラウドに同期';
      });

      document.getElementById('restoreFromCloud').addEventListener('click', async function() {
        if (!confirm('クラウドのデータでローカルデータを上書きしますか？')) return;
        this.disabled = true;
        this.textContent = '復元中...';
        try {
          await window.DataSync.restoreFromLarkBase();
          updateProgress();
        } catch (error) {
          console.error('Restore failed:', error);
          alert('復元に失敗しました: ' + error.message);
        }
        this.disabled = false;
        this.textContent = 'クラウドから復元';
      });

      document.getElementById('openLarkBase').addEventListener('click', function() {
        window.open(window.LARK_CONFIG.baseAppUrl, '_blank');
      });
    });

    // ユーザー名を保存
    document.getElementById('userName').addEventListener('change', function() {
      localStorage.setItem('selfUnderstanding_userName', this.value);
    });

    // 同期中オーバーレイ表示
    function showSyncingOverlay(show) {
      let overlay = document.getElementById('syncingOverlay');
      if (show) {
        if (!overlay) {
          overlay = document.createElement('div');
          overlay.id = 'syncingOverlay';
          overlay.innerHTML = `
            <div style="background: white; padding: 32px 48px; border-radius: 16px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
              <div style="width: 48px; height: 48px; border: 4px solid #f0f0f0; border-top-color: #ff9800; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
              <p style="margin: 0; font-weight: bold; color: #333;">データを同期中...</p>
              <p style="margin: 8px 0 0; font-size: 0.9rem; color: #666;">クラウドからデータを取得しています</p>
            </div>
          `;
          Object.assign(overlay.style, {
            position: 'fixed',
            top: '0',
            left: '0',
            right: '0',
            bottom: '0',
            background: 'rgba(0,0,0,0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: '10000'
          });
          // スピンアニメーション追加
          const style = document.createElement('style');
          style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
          document.head.appendChild(style);
          document.body.appendChild(overlay);
        }
        overlay.style.display = 'flex';
      } else if (overlay) {
        overlay.style.display = 'none';
      }
    }

    // Larkログイン状態をチェック
    function checkLarkLogin() {
      const larkUser = localStorage.getItem('selfUnderstanding_larkUser');
      const loggedOutView = document.getElementById('loggedOutView');
      const loggedInView = document.getElementById('loggedInView');
      const manualSection = document.getElementById('manualUserSection');

      if (larkUser) {
        const user = JSON.parse(larkUser);
        document.getElementById('userDisplayName').textContent = user.name;
        document.getElementById('userEmail').textContent = user.email || user.userId;
        const avatar = document.getElementById('userAvatar');
        if (user.avatar) {
          avatar.src = user.avatar;
          avatar.style.display = 'block';
        } else {
          avatar.style.display = 'none';
        }
        loggedOutView.style.display = 'none';
        loggedInView.style.display = 'block';
        manualSection.style.display = 'none';
      } else {
        loggedOutView.style.display = 'block';
        loggedInView.style.display = 'none';
        manualSection.style.display = 'block';
      }
    }

    // 進捗状況を更新
    function updateProgress() {
      const pages = ['personality', 'values', 'talent', 'passion', 'mission', 'become', 'life-manual'];
      let completed = 0;

      pages.forEach(page => {
        const data = localStorage.getItem(`selfUnderstanding_${page}`);
        const statusEl = document.getElementById(`status-${page}`);
        if (data) {
          completed++;
          if (statusEl) statusEl.textContent = '✅';
          const menuItem = document.querySelector(`[data-page="${page}"]`);
          if (menuItem) menuItem.classList.add('completed');
        }
      });

      const percent = Math.round((completed / pages.length) * 100);
      document.getElementById('totalProgress').style.width = percent + '%';
      document.getElementById('progressPercent').textContent = percent;
    }
  </script>
</body>
</html>
