<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>自己理解の教科書</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .hero {
      text-align: center;
      padding: var(--spacing-xl) var(--spacing-md);
      background: linear-gradient(135deg, var(--primary-orange) 0%, var(--primary-yellow) 100%);
      border-radius: 0 0 30px 30px;
      margin-bottom: var(--spacing-lg);
    }
    .hero h1 {
      color: var(--white);
      font-size: 1.8rem;
      margin-bottom: var(--spacing-sm);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    .hero p {
      color: var(--white);
      opacity: 0.9;
    }
    .menu-section {
      margin-bottom: var(--spacing-lg);
    }
    .menu-section-title {
      color: var(--primary-brown);
      font-size: 1rem;
      margin-bottom: var(--spacing-sm);
      padding-left: var(--spacing-sm);
      border-left: 4px solid var(--primary-orange);
    }
    .menu-item .icon {
      font-size: 1.5rem;
    }
    .menu-item .desc {
      font-size: 0.85rem;
      color: var(--text-light);
    }
    .user-info {
      background: var(--white);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }
    .progress-overview {
      background: var(--white);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }
    .progress-bar-large {
      height: 12px;
      background: var(--gray-light);
      border-radius: 6px;
      overflow: hidden;
      margin-top: var(--spacing-sm);
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-orange), var(--primary-yellow));
      border-radius: 6px;
      transition: width 0.5s;
    }
    .progress-text {
      text-align: right;
      font-size: 0.9rem;
      color: var(--text-light);
      margin-top: var(--spacing-xs);
    }
    /* ログイン/登録画面 */
    .login-screen {
      text-align: center;
      padding: var(--spacing-xl) var(--spacing-md);
    }
    .login-card {
      background: var(--white);
      padding: 40px 32px;
      border-radius: 16px;
      max-width: 400px;
      margin: 0 auto;
      box-shadow: var(--shadow-md);
    }
    .login-card h2 {
      color: var(--primary-brown);
      margin-bottom: var(--spacing-sm);
    }
    .login-card p {
      color: var(--text-light);
      font-size: 0.9rem;
      margin-bottom: var(--spacing-md);
      line-height: 1.6;
    }
    .form-group {
      margin-bottom: 16px;
      text-align: left;
    }
    .form-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: bold;
      color: var(--primary-brown);
      margin-bottom: 6px;
    }
    .form-group input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }
    .form-group input:focus {
      outline: none;
      border-color: var(--primary-orange);
    }
    .auth-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #ff9800, #ffc107);
      color: white;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 8px;
    }
    .auth-btn:hover {
      opacity: 0.9;
    }
    .auth-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .auth-switch {
      margin-top: 16px;
      font-size: 0.9rem;
      color: var(--text-light);
    }
    .auth-switch a {
      color: var(--primary-orange);
      text-decoration: none;
      font-weight: bold;
      cursor: pointer;
    }
    .auth-switch a:hover {
      text-decoration: underline;
    }
    .auth-error {
      background: #fff0f0;
      border: 1px solid #ffcdd2;
      color: #c62828;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.85rem;
      margin-bottom: 16px;
      display: none;
    }
    .auth-success {
      background: #e8f5e9;
      border: 1px solid #c8e6c9;
      color: #2e7d32;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.85rem;
      margin-bottom: 16px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="hero">
    <h1>自己理解の教科書</h1>
    <p>あなたらしい人生を歩むための<br>自己理解ワークブック</p>
  </div>

  <div class="container">
    <!-- ログイン画面（未ログイン時） -->
    <div id="loginScreen" class="login-screen">
      <!-- ログインフォーム -->
      <div id="loginForm" class="login-card">
        <h2>ログイン</h2>
        <p>メールアドレスとパスワードで<br>ログインしてください</p>
        <div id="loginError" class="auth-error"></div>
        <div class="form-group">
          <label for="loginEmail">メールアドレス</label>
          <input type="email" id="loginEmail" placeholder="example@mail.com" autocomplete="email">
        </div>
        <div class="form-group">
          <label for="loginPassword">パスワード</label>
          <input type="password" id="loginPassword" placeholder="6文字以上" autocomplete="current-password">
        </div>
        <button id="loginBtn" class="auth-btn">ログイン</button>
        <div class="auth-switch">
          アカウントをお持ちでない方は<br><a id="showRegister">アカウント作成</a>
        </div>
      </div>

      <!-- 登録フォーム -->
      <div id="registerForm" class="login-card" style="display: none;">
        <h2>アカウント作成</h2>
        <p>新しいアカウントを作成して<br>自己理解ワークを始めましょう</p>
        <div id="registerError" class="auth-error"></div>
        <div id="registerSuccess" class="auth-success"></div>
        <div class="form-group">
          <label for="registerName">お名前</label>
          <input type="text" id="registerName" placeholder="山田 太郎" autocomplete="name">
        </div>
        <div class="form-group">
          <label for="registerEmail">メールアドレス</label>
          <input type="email" id="registerEmail" placeholder="example@mail.com" autocomplete="email">
        </div>
        <div class="form-group">
          <label for="registerPassword">パスワード</label>
          <input type="password" id="registerPassword" placeholder="6文字以上" autocomplete="new-password">
        </div>
        <button id="registerBtn" class="auth-btn">アカウント作成</button>
        <div class="auth-switch">
          既にアカウントをお持ちの方は<br><a id="showLogin">ログインに戻る</a>
        </div>
      </div>
    </div>

    <!-- メインコンテンツ（ログイン後） -->
    <div id="mainContent" style="display: none;">
      <!-- ユーザー情報 -->
      <div class="user-info" id="userInfoSection">
        <div style="display: flex; align-items: center; gap: 12px;">
          <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #ff9800, #ffc107); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2rem;" id="userInitial"></div>
          <div style="flex: 1;">
            <div id="userDisplayName" style="font-weight: bold; color: var(--primary-brown);"></div>
            <div id="userEmail" style="font-size: 0.85rem; color: var(--text-light);"></div>
          </div>
          <button id="logoutBtn" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-size: 0.85rem;">ログアウト</button>
        </div>
      </div>

      <!-- 進捗状況 -->
      <div class="progress-overview">
        <strong>全体の進捗</strong>
        <div class="progress-bar-large">
          <div class="progress-bar-fill" id="totalProgress" style="width: 0%"></div>
        </div>
        <div class="progress-text"><span id="progressPercent">0</span>% 完了</div>
      </div>

      <!-- ガイド -->
      <div class="menu-section">
        <div class="menu-section-title">はじめに</div>
        <div class="menu-grid">
          <a href="pages/01-osaru-ai.html" class="menu-item" data-page="osaru-ai">
            <div class="number">0</div>
            <div>
              <div class="title">おさるAI</div>
              <div class="desc">24時間コーチングAIの紹介</div>
            </div>
            <div class="status" id="status-osaru-ai"></div>
          </a>
          <a href="pages/02-about.html" class="menu-item" data-page="about">
            <div class="number">0</div>
            <div>
              <div class="title">自己理解とは</div>
              <div class="desc">なぜ自己理解が必要なのか？</div>
            </div>
            <div class="status" id="status-about"></div>
          </a>
        </div>
      </div>

      <!-- 診断 -->
      <div class="menu-section">
        <div class="menu-section-title">性格診断</div>
        <div class="menu-grid">
          <a href="pages/03-personality.html" class="menu-item" data-page="personality">
            <div class="number">1</div>
            <div>
              <div class="title">性格診断ワーク</div>
              <div class="desc">うさぎ/かめ × アリ/キリギリス</div>
            </div>
            <div class="status" id="status-personality"></div>
          </a>
        </div>
      </div>

      <!-- 自己理解ワーク -->
      <div class="menu-section">
        <div class="menu-section-title">自己理解ワーク</div>
        <div class="menu-grid">
          <a href="pages/04-values.html" class="menu-item" data-page="values">
            <div class="number">2</div>
            <div>
              <div class="title">価値観ワーク</div>
              <div class="desc">何を大切にしたいか</div>
            </div>
            <div class="status" id="status-values"></div>
          </a>
          <a href="pages/05-talent.html" class="menu-item" data-page="talent">
            <div class="number">3</div>
            <div>
              <div class="title">才能ワーク</div>
              <div class="desc">無意識にできる強み</div>
            </div>
            <div class="status" id="status-talent"></div>
          </a>
          <a href="pages/06-passion.html" class="menu-item" data-page="passion">
            <div class="number">4</div>
            <div>
              <div class="title">情熱ワーク</div>
              <div class="desc">頑張らなくても頑張れること</div>
            </div>
            <div class="status" id="status-passion"></div>
          </a>
          <a href="pages/07-mission.html" class="menu-item" data-page="mission">
            <div class="number">5</div>
            <div>
              <div class="title">使命・判断軸ワーク</div>
              <div class="desc">人生の目的を見つける</div>
            </div>
            <div class="status" id="status-mission"></div>
          </a>
        </div>
      </div>

      <!-- まとめ -->
      <div class="menu-section">
        <div class="menu-section-title">まとめ</div>
        <div class="menu-grid">
          <a href="pages/08-become.html" class="menu-item" data-page="become">
            <div class="number">6</div>
            <div>
              <div class="title">なりたい自分ワーク</div>
              <div class="desc">5年後〜半年後の目標設定</div>
            </div>
            <div class="status" id="status-become"></div>
          </a>
          <a href="pages/09-life-manual.html" class="menu-item" data-page="life-manual">
            <div class="number">7</div>
            <div>
              <div class="title">人生の説明書</div>
              <div class="desc">すべてをまとめた自分マニュアル</div>
            </div>
            <div class="status" id="status-life-manual"></div>
          </a>
        </div>
      </div>

      <!-- AI分析 -->
      <div class="menu-section">
        <div class="menu-section-title">AI分析</div>
        <div class="menu-grid">
          <a href="pages/10-ai-analysis.html" class="menu-item" data-page="ai-analysis">
            <div class="number" style="background: var(--primary-green);">AI</div>
            <div>
              <div class="title">AI自己分析</div>
              <div class="desc">入力内容をAIが総合分析</div>
            </div>
            <div class="status" id="status-ai-analysis"></div>
          </a>
        </div>
      </div>

      <!-- 管理（管理者のみ表示） -->
      <div class="menu-section" id="adminSection" style="display:none;">
        <div class="menu-section-title">管理</div>
        <div class="menu-grid">
          <a href="pages/admin.html" class="menu-item">
            <div class="number" style="background: #546e7a;">&#9881;</div>
            <div>
              <div class="title">管理画面</div>
              <div class="desc">AIプロンプト設定</div>
            </div>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Lark API連携 -->
  <script src="js/lark-api.js"></script>
  <script src="js/lark-config.js"></script>
  <script src="js/data-sync.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // ログイン状態をチェックして画面を切り替え
      checkLogin();

      // ログイン後の自動同期（Lark Baseからデータ復元）
      const needSync = localStorage.getItem('selfUnderstanding_needSync');
      if (needSync === 'true') {
        localStorage.removeItem('selfUnderstanding_needSync');
        setTimeout(async () => {
          try {
            showSyncingOverlay(true);
            // DataSyncが初期化されていなければ手動で初期化
            if (window.DataSync) {
              if (!window.DataSync.userId) window.DataSync.init();
              await window.DataSync.syncOnLogin();
            }
            updateProgress();
          } catch (error) {
            console.error('Auto sync failed:', error);
          } finally {
            showSyncingOverlay(false);
          }
        }, 500);
      }

      // 進捗状況を更新
      updateProgress();

      // フォーム切り替え
      document.getElementById('showRegister').addEventListener('click', function() {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('registerForm').style.display = 'block';
        clearErrors();
      });

      document.getElementById('showLogin').addEventListener('click', function() {
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('loginForm').style.display = 'block';
        clearErrors();
      });

      // ログインボタン
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
      // Enterキーでログイン
      document.getElementById('loginPassword').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') handleLogin();
      });

      // 登録ボタン
      document.getElementById('registerBtn').addEventListener('click', handleRegister);
      // Enterキーで登録
      document.getElementById('registerPassword').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') handleRegister();
      });

      // ログアウトボタン
      document.getElementById('logoutBtn').addEventListener('click', function() {
        localStorage.removeItem('selfUnderstanding_larkUser');
        localStorage.removeItem('selfUnderstanding_userId');
        localStorage.removeItem('selfUnderstanding_userName');
        checkLogin();
      });
    });

    // ログイン処理
    async function handleLogin() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');
      const btn = document.getElementById('loginBtn');

      errorEl.style.display = 'none';

      if (!email || !password) {
        errorEl.textContent = 'メールアドレスとパスワードを入力してください';
        errorEl.style.display = 'block';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'ログイン中...';

      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (!response.ok) {
          errorEl.textContent = data.error || 'ログインに失敗しました';
          errorEl.style.display = 'block';
          return;
        }

        // ログイン成功 - ユーザー情報をlocalStorageに保存
        const userData = {
          userId: data.userId,
          name: data.name,
          email: data.email,
          loginAt: new Date().toISOString()
        };
        localStorage.setItem('selfUnderstanding_larkUser', JSON.stringify(userData));
        localStorage.setItem('selfUnderstanding_userId', userData.userId);
        localStorage.setItem('selfUnderstanding_userName', userData.name);
        localStorage.setItem('selfUnderstanding_needSync', 'true');

        // ページリロードで同期を開始
        window.location.reload();

      } catch (error) {
        errorEl.textContent = 'ネットワークエラーが発生しました。接続を確認してください。';
        errorEl.style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.textContent = 'ログイン';
      }
    }

    // 登録処理
    async function handleRegister() {
      const name = document.getElementById('registerName').value.trim();
      const email = document.getElementById('registerEmail').value.trim();
      const password = document.getElementById('registerPassword').value;
      const errorEl = document.getElementById('registerError');
      const successEl = document.getElementById('registerSuccess');
      const btn = document.getElementById('registerBtn');

      errorEl.style.display = 'none';
      successEl.style.display = 'none';

      if (!name || !email || !password) {
        errorEl.textContent = '全ての項目を入力してください';
        errorEl.style.display = 'block';
        return;
      }

      if (password.length < 6) {
        errorEl.textContent = 'パスワードは6文字以上で入力してください';
        errorEl.style.display = 'block';
        return;
      }

      btn.disabled = true;
      btn.textContent = '登録中...';

      try {
        const response = await fetch('/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, name, password })
        });

        const data = await response.json();

        if (!response.ok) {
          errorEl.textContent = data.error || '登録に失敗しました';
          errorEl.style.display = 'block';
          return;
        }

        // 登録成功
        successEl.textContent = 'アカウント作成が完了しました！ログインしてください。';
        successEl.style.display = 'block';

        // 2秒後にログインフォームに切り替え（メールを自動入力）
        setTimeout(() => {
          document.getElementById('registerForm').style.display = 'none';
          document.getElementById('loginForm').style.display = 'block';
          document.getElementById('loginEmail').value = email;
          document.getElementById('loginPassword').focus();
          clearErrors();
        }, 2000);

      } catch (error) {
        errorEl.textContent = 'ネットワークエラーが発生しました。接続を確認してください。';
        errorEl.style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.textContent = 'アカウント作成';
      }
    }

    // エラーメッセージをクリア
    function clearErrors() {
      document.getElementById('loginError').style.display = 'none';
      document.getElementById('registerError').style.display = 'none';
      document.getElementById('registerSuccess').style.display = 'none';
    }

    // 同期中オーバーレイ表示
    function showSyncingOverlay(show) {
      let overlay = document.getElementById('syncingOverlay');
      if (show) {
        if (!overlay) {
          overlay = document.createElement('div');
          overlay.id = 'syncingOverlay';
          overlay.innerHTML = `
            <div style="background: white; padding: 32px 48px; border-radius: 16px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
              <div style="width: 48px; height: 48px; border: 4px solid #f0f0f0; border-top-color: #ff9800; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
              <p style="margin: 0; font-weight: bold; color: #333;">データを同期中...</p>
              <p style="margin: 8px 0 0; font-size: 0.9rem; color: #666;">クラウドからデータを取得しています</p>
            </div>
          `;
          Object.assign(overlay.style, {
            position: 'fixed',
            top: '0',
            left: '0',
            right: '0',
            bottom: '0',
            background: 'rgba(0,0,0,0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: '10000'
          });
          const style = document.createElement('style');
          style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
          document.head.appendChild(style);
          document.body.appendChild(overlay);
        }
        overlay.style.display = 'flex';
      } else if (overlay) {
        overlay.style.display = 'none';
      }
    }

    // 管理者メールリスト
    const ADMIN_EMAILS = ['garden.quattro@gmail.com'];

    function isAdmin() {
      try {
        const user = JSON.parse(localStorage.getItem('selfUnderstanding_larkUser') || '{}');
        return ADMIN_EMAILS.includes(user.email);
      } catch { return false; }
    }

    // ログイン状態をチェック → 画面切り替え
    function checkLogin() {
      const storedUser = localStorage.getItem('selfUnderstanding_larkUser');
      const loginScreen = document.getElementById('loginScreen');
      const mainContent = document.getElementById('mainContent');

      if (storedUser) {
        const user = JSON.parse(storedUser);
        document.getElementById('userDisplayName').textContent = user.name;
        document.getElementById('userEmail').textContent = user.email || user.userId;

        // イニシャルアイコン
        const initial = (user.name || '?').charAt(0).toUpperCase();
        document.getElementById('userInitial').textContent = initial;

        loginScreen.style.display = 'none';
        mainContent.style.display = 'block';

        // 管理者のみ管理セクションを表示
        const adminSection = document.getElementById('adminSection');
        if (adminSection) {
          adminSection.style.display = isAdmin() ? '' : 'none';
        }
      } else {
        loginScreen.style.display = 'block';
        mainContent.style.display = 'none';
      }
    }

    // 進捗状況を更新
    function updateProgress() {
      const pages = ['osaru-ai', 'about', 'personality', 'values', 'talent', 'passion', 'mission', 'become', 'life-manual'];
      let completed = 0;

      pages.forEach(page => {
        const data = localStorage.getItem(`selfUnderstanding_${page}`);
        const statusEl = document.getElementById(`status-${page}`);
        if (data) {
          completed++;
          if (statusEl) statusEl.textContent = '\u2705';
          const menuItem = document.querySelector(`[data-page="${page}"]`);
          if (menuItem) menuItem.classList.add('completed');
        }
      });

      const percent = Math.round((completed / pages.length) * 100);
      document.getElementById('totalProgress').style.width = percent + '%';
      document.getElementById('progressPercent').textContent = percent;
    }
  </script>
</body>
</html>
