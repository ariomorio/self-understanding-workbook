<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>コーチダッシュボード | マイコンパス</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .admin-header {
      background: linear-gradient(135deg, #1565c0, #42a5f5);
      padding: var(--spacing-lg) var(--spacing-md);
      color: var(--white);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 0 0 20px 20px;
      margin-bottom: var(--spacing-lg);
    }
    .admin-header .coach-info h1 {
      font-size: 1.2rem;
      margin-bottom: 4px;
    }
    .admin-header .coach-info p {
      font-size: 0.85rem;
      opacity: 0.8;
    }
    .admin-header .logout-btn {
      padding: 8px 16px;
      border: 1px solid rgba(255,255,255,0.5);
      border-radius: var(--radius-sm);
      background: transparent;
      color: var(--white);
      cursor: pointer;
      font-size: 0.85rem;
    }
    .admin-header .logout-btn:hover {
      background: rgba(255,255,255,0.15);
    }
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--spacing-md);
    }
    .section-header h2 {
      font-size: 1.1rem;
      color: var(--text-dark);
    }
    .add-btn {
      padding: 8px 16px;
      border: none;
      border-radius: var(--radius-sm);
      background: #1565c0;
      color: var(--white);
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: bold;
    }
    .add-btn:hover { opacity: 0.9; }
    .member-card {
      background: var(--white);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-sm);
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      cursor: pointer;
      transition: box-shadow 0.2s;
      text-decoration: none;
      color: inherit;
    }
    .member-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    .member-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      flex-shrink: 0;
    }
    .member-info {
      flex: 1;
      min-width: 0;
    }
    .member-info .name {
      font-weight: bold;
      color: var(--text-dark);
      margin-bottom: 2px;
    }
    .member-info .email {
      font-size: 0.8rem;
      color: var(--text-light);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .member-arrow {
      color: #bbb;
      font-size: 1.2rem;
    }
    .empty-state {
      text-align: center;
      padding: var(--spacing-xl);
      color: var(--text-light);
    }
    .empty-state .icon { font-size: 3rem; margin-bottom: var(--spacing-sm); }
    .loading {
      text-align: center;
      padding: var(--spacing-xl);
      color: var(--text-light);
    }

    /* モーダル */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      width: 90%;
      max-width: 400px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }
    .modal h3 {
      margin-bottom: var(--spacing-md);
      color: var(--text-dark);
    }
    .modal input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: var(--radius-sm);
      font-size: 1rem;
      margin-bottom: var(--spacing-md);
      box-sizing: border-box;
    }
    .modal input:focus {
      outline: none;
      border-color: #1565c0;
    }
    .modal-actions {
      display: flex;
      gap: var(--spacing-sm);
      justify-content: flex-end;
    }
    .modal-actions button {
      padding: 10px 20px;
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      cursor: pointer;
      border: none;
    }
    .modal-cancel {
      background: #e0e0e0;
      color: var(--text-dark);
    }
    .modal-submit {
      background: #1565c0;
      color: var(--white);
      font-weight: bold;
    }
    .modal-submit:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .modal-error {
      color: #d32f2f;
      font-size: 0.85rem;
      margin-bottom: var(--spacing-sm);
      display: none;
    }

    /* タブナビゲーション */
    .tab-nav {
      display: flex;
      gap: 0;
      margin-bottom: var(--spacing-lg);
      background: #f5f5f5;
      border-radius: var(--radius-md);
      padding: 4px;
    }
    .tab-btn {
      flex: 1;
      padding: 12px 8px;
      border: none;
      border-radius: calc(var(--radius-md) - 2px);
      background: transparent;
      color: var(--text-light);
      font-size: 0.9rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tab-btn.active {
      background: var(--white);
      color: #1565c0;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* プロンプト設定 */
    .prompt-card {
      background: var(--white);
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
      box-shadow: var(--shadow-sm);
    }
    .prompt-card h3 {
      color: #1565c0;
      margin-bottom: var(--spacing-sm);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .prompt-textarea {
      width: 100%;
      min-height: 300px;
      padding: var(--spacing-md);
      border: 2px solid #e0e0e0;
      border-radius: var(--radius-sm);
      font-family: monospace;
      font-size: 0.9rem;
      line-height: 1.6;
      resize: vertical;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }
    .prompt-textarea:focus {
      outline: none;
      border-color: #1565c0;
    }
    .prompt-actions {
      display: flex;
      gap: 8px;
      margin-top: var(--spacing-md);
      flex-wrap: wrap;
    }
    .prompt-btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: bold;
      cursor: pointer;
      font-size: 0.9rem;
      transition: opacity 0.2s;
    }
    .prompt-btn:hover { opacity: 0.9; }
    .prompt-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .prompt-btn.primary { background: #1565c0; color: white; }
    .prompt-btn.secondary { background: #e0e0e0; color: #333; }
    .prompt-btn.test { background: #4caf50; color: white; }
    .char-count {
      text-align: right;
      font-size: 0.85rem;
      color: var(--text-light);
      margin-top: 4px;
    }
    .prompt-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: bold;
      margin-left: auto;
    }
    .prompt-status.saved { background: #e8f5e9; color: #2e7d32; }
    .prompt-status.default { background: #fff3e0; color: #e65100; }
    .prompt-status.loading { background: #e3f2fd; color: #1565c0; }
    .hint-card {
      background: #e8f5e9;
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }
    .hint-card h4 { color: #2e7d32; margin-bottom: var(--spacing-sm); }
    .hint-card li { margin-bottom: 6px; line-height: 1.6; }
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: bold;
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    .toast.success { background: #e8f5e9; color: #2e7d32; }
    .toast.error { background: #ffebee; color: #c62828; }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>
  <div class="admin-header">
    <div class="coach-info">
      <h1 id="coachName">Loading...</h1>
      <p id="coachEmail"></p>
    </div>
    <button class="logout-btn" id="logoutBtn">ログアウト</button>
  </div>

  <div class="container">
    <!-- タブナビゲーション -->
    <div class="tab-nav">
      <button class="tab-btn active" data-tab="members" onclick="switchTab('members')">メンバー</button>
      <button class="tab-btn" data-tab="prompt" onclick="switchTab('prompt')">AIプロンプト設定</button>
    </div>

    <!-- メンバータブ -->
    <div class="tab-content active" id="tab-members">
      <div class="section-header">
        <h2>メンバー一覧</h2>
        <button class="add-btn" id="addMemberBtn">+ 追加</button>
      </div>
      <div id="membersList">
        <div class="loading">読み込み中...</div>
      </div>
    </div>

    <!-- AIプロンプト設定タブ -->
    <div class="tab-content" id="tab-prompt">
      <div class="prompt-card">
        <h3>
          <span>&#x1F916; AI分析プロンプト</span>
          <span class="prompt-status loading" id="promptStatus">読み込み中...</span>
        </h3>
        <p style="color:var(--text-light); font-size:0.9rem; margin-bottom:var(--spacing-md);">
          メンバーがAI自己分析を実行する際に使われるシステムプロンプトです。<br>
          <code>{userName}</code> はメンバーの名前に自動置換されます。
        </p>
        <textarea class="prompt-textarea" id="promptEditor" placeholder="プロンプトを読み込み中..."></textarea>
        <div class="char-count"><span id="charCount">0</span>文字</div>
        <div class="prompt-actions">
          <button class="prompt-btn primary" id="savePromptBtn" onclick="savePrompt()">&#x1F4BE; 保存する</button>
          <button class="prompt-btn secondary" onclick="loadDefaultPrompt()">&#x1F504; デフォルトに戻す</button>
          <button class="prompt-btn test" onclick="testPrompt()">&#x25B6; テスト分析</button>
        </div>
      </div>

      <div class="hint-card">
        <h4>&#x1F4A1; プロンプト設計のヒント</h4>
        <ul style="padding-left: var(--spacing-md);">
          <li><strong>分析の切り口を指定</strong>: 「強み」「SNS発信テーマ」「アクションプラン」など</li>
          <li><strong>口調を指定</strong>: 「暖かく応援する」「論理的に」「友達のように」など</li>
          <li><strong>フォーマットを指定</strong>: 「マークダウンで」「見出し付きで」「箇条書きで」</li>
          <li><strong>ペルソナを設定</strong>: 「あなたは自己理解コーチです」など</li>
          <li><strong>具体例の引用</strong>: 「ユーザーのエピソードを引用して」</li>
        </ul>
      </div>

      <!-- テスト結果 -->
      <div class="prompt-card" id="testResultCard" style="display:none;">
        <h3>&#x1F9EA; テスト結果</h3>
        <div id="testResult" style="white-space:pre-wrap; line-height:1.8; font-size:0.9rem; max-height:400px; overflow-y:auto; padding:var(--spacing-md); background:#f5f5f5; border-radius:var(--radius-sm);"></div>
      </div>
    </div>
  </div>
  <div class="toast" id="toast"></div>

  <!-- メンバー追加モーダル -->
  <div class="modal-overlay" id="addModal">
    <div class="modal">
      <h3>メンバーを追加</h3>
      <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: var(--spacing-md);">
        メンバーの登録済みメールアドレスを入力してください
      </p>
      <input type="email" id="memberEmail" placeholder="member@example.com">
      <div class="modal-error" id="modalError"></div>
      <div class="modal-actions">
        <button class="modal-cancel" id="modalCancel">キャンセル</button>
        <button class="modal-submit" id="modalSubmit">追加</button>
      </div>
    </div>
  </div>

  <script src="../js/admin-auth.js"></script>
  <script src="../js/admin-api.js"></script>
  <script>
    let coach = null;

    async function init() {
      // コーチ認証チェック
      coach = AdminAuth.getCoach();
      if (!coach) {
        window.location.href = 'admin-login.html';
        return;
      }

      // UI にコーチ情報を表示
      document.getElementById('coachName').textContent = coach.name;
      document.getElementById('coachEmail').textContent = coach.email;

      // サーバー側で認証を検証（バックグラウンド）
      const result = await AdminAuth.verify();
      if (!result.valid) {
        AdminAuth.logout();
        return;
      }

      // メンバー一覧を読み込み
      await loadMembers();
    }

    async function loadMembers() {
      const listEl = document.getElementById('membersList');
      listEl.innerHTML = '<div class="loading">読み込み中...</div>';

      try {
        const data = await AdminAPI.getMembers(coach.userId);
        renderMembers(data.members);
      } catch (error) {
        listEl.innerHTML = `<div class="empty-state"><div class="icon">&#x26A0;&#xFE0F;</div><p>${error.message}</p></div>`;
      }
    }

    function renderMembers(members) {
      const listEl = document.getElementById('membersList');

      if (members.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state">
            <div class="icon">&#x1F465;</div>
            <p>メンバーがまだいません。<br>「+ 追加」からメンバーを割り当てましょう。</p>
          </div>
        `;
        return;
      }

      listEl.innerHTML = members.map(m => `
        <a class="member-card" href="admin-member-view.html?member_id=${encodeURIComponent(m.userId)}">
          <div class="member-avatar">&#x1F9D1;</div>
          <div class="member-info">
            <div class="name">${escapeHtml(m.name)}</div>
            <div class="email">${escapeHtml(m.email)}</div>
          </div>
          <div class="member-arrow">&#x203A;</div>
        </a>
      `).join('');
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // ログアウト
    document.getElementById('logoutBtn').addEventListener('click', function() {
      AdminAuth.logout();
    });

    // メンバー追加モーダル
    const modal = document.getElementById('addModal');
    const emailInput = document.getElementById('memberEmail');
    const modalError = document.getElementById('modalError');
    const submitBtn = document.getElementById('modalSubmit');

    document.getElementById('addMemberBtn').addEventListener('click', function() {
      modal.classList.add('active');
      emailInput.value = '';
      modalError.style.display = 'none';
      emailInput.focus();
    });

    document.getElementById('modalCancel').addEventListener('click', function() {
      modal.classList.remove('active');
    });

    modal.addEventListener('click', function(e) {
      if (e.target === modal) modal.classList.remove('active');
    });

    submitBtn.addEventListener('click', async function() {
      const email = emailInput.value.trim();
      if (!email) return;

      submitBtn.disabled = true;
      submitBtn.textContent = '...';
      modalError.style.display = 'none';

      try {
        await AdminAPI.assignMember(coach.userId, email);
        modal.classList.remove('active');
        await loadMembers();
      } catch (error) {
        modalError.textContent = error.message;
        modalError.style.display = 'block';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '追加';
      }
    });

    // Enter キーで送信
    emailInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitBtn.click();
      }
    });

    // ── タブ切り替え ──
    function switchTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(function(btn) {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === tabName);
      });
      document.querySelectorAll('.tab-content').forEach(function(content) {
        content.classList.toggle('active', content.id === 'tab-' + tabName);
      });
      // プロンプトタブに切り替えたら読み込み
      if (tabName === 'prompt' && !promptLoaded) {
        loadPrompt();
      }
    }

    // ── AIプロンプト設定 ──
    var promptLoaded = false;

    var DEFAULT_PROMPT = 'あなたは自己理解コーチ「おさるAI」です。\n以下のワークデータを分析して、ユーザーの自己理解を深める総合レポートを作成してください。\n\n## 分析してほしいこと\n1. **あなたの強み・特徴まとめ** - 全体を通して見えてくるユーザーの本質的な強みと特徴\n2. **価値観・才能・情熱の一貫性** - 3つの柱がどのように繋がっているか\n3. **SNS発信で活かせるテーマ** - ユーザーに合った発信テーマや切り口の提案\n4. **商品・サービス化の方向性** - ユーザーの強みを活かしたビジネスの可能性\n5. **今後のアクションプラン** - 具体的な次のステップ3つ\n\n## ルール\n- 暖かく、応援する口調で書く\n- 具体的なエピソードを引用しながら分析する\n- マークダウン形式で見出し・箇条書きを使う\n- 「あなた」ではなく入力した名前で呼びかける（名前が無い場合は「あなた」）';

    async function loadPrompt() {
      if (!coach) return;
      var editor = document.getElementById('promptEditor');
      var statusEl = document.getElementById('promptStatus');

      statusEl.className = 'prompt-status loading';
      statusEl.textContent = '読み込み中...';

      try {
        var data = await AdminAPI.getPrompt(coach.userId);
        if (data.prompt) {
          editor.value = data.prompt;
          statusEl.className = 'prompt-status saved';
          statusEl.textContent = '\u2705 カスタム設定';
        } else {
          editor.value = DEFAULT_PROMPT;
          statusEl.className = 'prompt-status default';
          statusEl.textContent = '\u26A0\uFE0F デフォルト';
        }
        promptLoaded = true;
      } catch (error) {
        editor.value = DEFAULT_PROMPT;
        statusEl.className = 'prompt-status default';
        statusEl.textContent = '\u26A0\uFE0F デフォルト';
        promptLoaded = true;
      }
      updateCharCount();
    }

    async function savePrompt() {
      if (!coach) return;
      var editor = document.getElementById('promptEditor');
      var text = editor.value.trim();
      if (!text) {
        showToast('\u30D7\u30ED\u30F3\u30D7\u30C8\u304C\u7A7A\u3067\u3059', 'error');
        return;
      }

      var btn = document.getElementById('savePromptBtn');
      btn.disabled = true;
      btn.textContent = '\u4FDD\u5B58\u4E2D...';

      try {
        await AdminAPI.savePrompt(coach.userId, text);
        var statusEl = document.getElementById('promptStatus');
        statusEl.className = 'prompt-status saved';
        statusEl.textContent = '\u2705 カスタム設定';
        showToast('\u30D7\u30ED\u30F3\u30D7\u30C8\u3092\u4FDD\u5B58\u3057\u307E\u3057\u305F');
      } catch (error) {
        showToast('\u4FDD\u5B58\u306B\u5931\u6557: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = '\uD83D\uDCBE \u4FDD\u5B58\u3059\u308B';
      }
    }

    function loadDefaultPrompt() {
      if (confirm('\u30C7\u30D5\u30A9\u30EB\u30C8\u306E\u30D7\u30ED\u30F3\u30D7\u30C8\u306B\u623B\u3057\u307E\u3059\u304B\uFF1F')) {
        document.getElementById('promptEditor').value = DEFAULT_PROMPT;
        updateCharCount();
        showToast('\u30C7\u30D5\u30A9\u30EB\u30C8\u306B\u623B\u3057\u307E\u3057\u305F');
      }
    }

    async function testPrompt() {
      if (!coach) return;
      var prompt = document.getElementById('promptEditor').value.trim();
      if (!prompt) {
        showToast('\u30D7\u30ED\u30F3\u30D7\u30C8\u304C\u7A7A\u3067\u3059', 'error');
        return;
      }

      showToast('\u30C6\u30B9\u30C8\u5206\u6790\u3092\u958B\u59CB\u3057\u3066\u3044\u307E\u3059...');

      try {
        var response = await fetch('/api/ai-analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userData: {
              userName: '\u30C6\u30B9\u30C8\u30E6\u30FC\u30B6\u30FC',
              values: {
                q1: '\u30C1\u30FC\u30E0\u3067\u5927\u304D\u306A\u30D7\u30ED\u30B8\u30A7\u30AF\u30C8\u3092\u6210\u529F\u3055\u305B\u305F\u3068\u304D',
                q8: { selected: ['\u4FE1\u983C', '\u6311\u6226', '\u81EA\u5DF1\u6210\u9577', '\u81EA\u7531', '\u611F\u8B1D\u3055\u308C\u308B'] },
                summary: '\u4FE1\u983C\u95A2\u4FC2\u3092\u5927\u5207\u306B\u3057\u306A\u304C\u3089\u3001\u6311\u6226\u3092\u901A\u3058\u3066\u6210\u9577\u3057\u3066\u3044\u304D\u305F\u3044'
              },
              talent: {
                q1: '\u4EBA\u306E\u8A71\u3092\u4E01\u5BE7\u306B\u805E\u3044\u3066\u304F\u308C\u308B\u3068\u611F\u8B1D\u3055\u308C\u305F',
                q7: ['\u50BE\u8074\u529B', '\u30B3\u30DF\u30E5\u30CB\u30B1\u30FC\u30B7\u30E7\u30F3\u529B', '\u5171\u611F\u529B'],
                q9: '\u4EBA\u306E\u6C17\u6301\u3061\u306B\u5BC4\u308A\u6DFB\u3044\u306A\u304C\u3089\u3001\u89E3\u6C7A\u7B56\u3092\u4E00\u7DD2\u306B\u8003\u3048\u308B\u529B\u304C\u3042\u308B'
              }
            },
            customPrompt: prompt
          })
        });

        if (!response.ok) {
          var err = await response.json();
          throw new Error(err.error || '\u30C6\u30B9\u30C8\u5931\u6557');
        }

        var data = await response.json();
        document.getElementById('testResult').textContent = data.analysis || '\u7D50\u679C\u306A\u3057';
        document.getElementById('testResultCard').style.display = 'block';
        showToast('\u30C6\u30B9\u30C8\u5206\u6790\u304C\u5B8C\u4E86\u3057\u307E\u3057\u305F');
      } catch (error) {
        showToast('\u30C6\u30B9\u30C8\u5931\u6557: ' + error.message, 'error');
      }
    }

    function updateCharCount() {
      var editor = document.getElementById('promptEditor');
      if (editor) {
        document.getElementById('charCount').textContent = editor.value.length;
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      var editor = document.getElementById('promptEditor');
      if (editor) editor.addEventListener('input', updateCharCount);
    });

    function showToast(message, type) {
      var toast = document.getElementById('toast');
      if (!toast) return;
      toast.textContent = message;
      toast.className = 'toast ' + (type || 'success') + ' show';
      setTimeout(function() { toast.classList.remove('show'); }, 3000);
    }

    // 初期化
    init();
  </script>
</body>
</html>
