<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIè‡ªå·±åˆ†æ | è‡ªå·±ç†è§£ã®æ•™ç§‘æ›¸</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .ai-header {
      background: linear-gradient(135deg, #673ab7, #9c27b0);
      padding: var(--spacing-lg);
      border-radius: var(--radius-lg);
      text-align: center;
      color: var(--white);
      margin-bottom: var(--spacing-lg);
    }
    .ai-header .emoji { font-size: 3rem; margin-bottom: var(--spacing-sm); }
    .data-summary {
      background: var(--white);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      box-shadow: var(--shadow-sm);
    }
    .data-summary h3 {
      color: var(--primary-brown);
      margin-bottom: var(--spacing-sm);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    .data-item {
      display: flex;
      justify-content: space-between;
      padding: var(--spacing-xs) 0;
      border-bottom: 1px solid #eee;
    }
    .data-item:last-child { border-bottom: none; }
    .data-item .label { color: var(--text-light); }
    .data-item .value { font-weight: bold; }
    .data-item .value.complete { color: var(--primary-green); }
    .data-item .value.incomplete { color: var(--gray); }
    .analysis-btn {
      display: block;
      width: 100%;
      background: linear-gradient(135deg, #673ab7, #9c27b0);
      color: var(--white);
      padding: var(--spacing-md);
      border: none;
      border-radius: var(--radius-md);
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-bottom: var(--spacing-lg);
    }
    .analysis-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .analysis-btn:disabled {
      background: var(--gray);
      cursor: not-allowed;
    }
    .analysis-result {
      background: var(--white);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      box-shadow: var(--shadow-sm);
      display: none;
    }
    .analysis-result.show { display: block; }
    .analysis-result h3 {
      color: #673ab7;
      margin-bottom: var(--spacing-md);
      text-align: center;
    }
    .analysis-section {
      background: var(--gray-light);
      padding: var(--spacing-md);
      border-radius: var(--radius-sm);
      margin-bottom: var(--spacing-md);
    }
    .analysis-section h4 {
      color: var(--primary-brown);
      margin-bottom: var(--spacing-sm);
    }
    .export-btn {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
      background: var(--primary-green);
      color: var(--white);
      padding: var(--spacing-sm) var(--spacing-md);
      border: none;
      border-radius: var(--radius-sm);
      font-weight: bold;
      cursor: pointer;
      margin-right: var(--spacing-sm);
      margin-bottom: var(--spacing-sm);
    }
    .export-btn:hover { opacity: 0.9; }
    .copy-prompt-box {
      background: #f5f5f5;
      padding: var(--spacing-md);
      border-radius: var(--radius-sm);
      margin-top: var(--spacing-md);
      position: relative;
    }
    .copy-prompt-box pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 0.85rem;
      max-height: 300px;
      overflow-y: auto;
    }
    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--primary-orange);
      color: var(--white);
      border: none;
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 0.85rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³é¢¨ã®åˆ†æçµæœè¡¨ç¤º */
    #resultContent h1, #resultContent h2, #resultContent h3 {
      color: #673ab7;
      margin: var(--spacing-md) 0 var(--spacing-sm);
    }
    #resultContent h1 { font-size: 1.4rem; border-bottom: 2px solid #673ab7; padding-bottom: 8px; }
    #resultContent h2 { font-size: 1.2rem; }
    #resultContent h3 { font-size: 1.05rem; }
    #resultContent ul, #resultContent ol {
      padding-left: var(--spacing-md);
      margin: var(--spacing-sm) 0;
    }
    #resultContent li { margin-bottom: 6px; line-height: 1.6; }
    #resultContent p { margin: var(--spacing-sm) 0; line-height: 1.7; }
    #resultContent strong { color: var(--primary-brown); }
    #resultContent blockquote {
      border-left: 4px solid #673ab7;
      padding: 8px 16px;
      background: #f3e5f5;
      border-radius: 0 8px 8px 0;
      margin: var(--spacing-sm) 0;
    }
    #resultContent hr { border: none; border-top: 1px solid #e0e0e0; margin: var(--spacing-md) 0; }
  </style>
</head>
<body>
  <header class="page-header" style="background: linear-gradient(135deg, #673ab7, #9c27b0);">
    <h1><span class="icon">ğŸ¤–</span> AIè‡ªå·±åˆ†æ</h1>
  </header>

  <div class="container">
    <div class="ai-header">
      <div class="emoji">ğŸ¤–</div>
      <h2>å…¥åŠ›ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’AIãŒç·åˆåˆ†æ</h2>
      <p>ã“ã‚Œã¾ã§ã®ãƒ¯ãƒ¼ã‚¯ã®å›ç­”ã‚’ã‚‚ã¨ã«<br>ã‚ãªãŸã®è‡ªå·±ç†è§£ã‚’æ·±ã‚ã‚‹ã‚µãƒãƒ¼ãƒˆã‚’ã—ã¾ã™</p>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿çŠ¶æ³ -->
    <div class="data-summary">
      <h3>ğŸ“Š å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®çŠ¶æ³</h3>
      <div class="data-item">
        <span class="label">æ€§æ ¼è¨ºæ–­</span>
        <span class="value" id="status-personality">æœªå…¥åŠ›</span>
      </div>
      <div class="data-item">
        <span class="label">ä¾¡å€¤è¦³ãƒ¯ãƒ¼ã‚¯</span>
        <span class="value" id="status-values">æœªå…¥åŠ›</span>
      </div>
      <div class="data-item">
        <span class="label">æ‰èƒ½ãƒ¯ãƒ¼ã‚¯</span>
        <span class="value" id="status-talent">æœªå…¥åŠ›</span>
      </div>
      <div class="data-item">
        <span class="label">æƒ…ç†±ãƒ¯ãƒ¼ã‚¯</span>
        <span class="value" id="status-passion">æœªå…¥åŠ›</span>
      </div>
      <div class="data-item">
        <span class="label">ä½¿å‘½ãƒ»åˆ¤æ–­è»¸ãƒ¯ãƒ¼ã‚¯</span>
        <span class="value" id="status-mission">æœªå…¥åŠ›</span>
      </div>
      <div class="data-item">
        <span class="label">äººç”Ÿã®èª¬æ˜æ›¸</span>
        <span class="value" id="status-life-manual">æœªå…¥åŠ›</span>
      </div>
    </div>

    <!-- AIåˆ†æå®Ÿè¡Œ -->
    <div class="data-summary">
      <h3>ğŸ¯ AIã«åˆ†æã—ã¦ã‚‚ã‚‰ã†</h3>
      <p style="margin-bottom: var(--spacing-md);">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€AIãŒã‚ãªãŸã®å…¨ãƒ¯ãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚</p>

      <button class="analysis-btn" id="aiAnalyzeBtn" onclick="runAIAnalysis()">
        ğŸ¤– AIã«åˆ†æã—ã¦ã‚‚ã‚‰ã†
      </button>

      <div id="analysisLoading" style="display:none; text-align:center; padding: var(--spacing-lg);">
        <div style="width:48px;height:48px;border:4px solid #f0f0f0;border-top-color:#673ab7;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px;"></div>
        <p style="font-weight:bold;color:#673ab7;">AIãŒåˆ†æä¸­...</p>
        <p style="font-size:0.9rem;color:var(--text-light);">30ç§’ã€œ1åˆ†ã»ã©ãŠå¾…ã¡ãã ã•ã„</p>
      </div>

      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:var(--spacing-sm);">
        <button class="export-btn" onclick="generatePrompt()">
          ğŸ“‹ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼
        </button>
        <button class="export-btn" onclick="exportJSON()" style="background: #2196f3;">
          ğŸ’¾ JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        </button>
        <button class="export-btn" onclick="clearAllData()" style="background: #f44336;">
          ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
        </button>
      </div>

      <div class="copy-prompt-box" id="promptBox" style="display: none;">
        <button class="copy-btn" onclick="copyPrompt()">ã‚³ãƒ”ãƒ¼</button>
        <pre id="promptText"></pre>
      </div>
    </div>

    <!-- åˆ†æçµæœ -->
    <div class="analysis-result" id="analysisResult">
      <h3>ğŸ“ˆ AIåˆ†æãƒ¬ãƒãƒ¼ãƒˆ</h3>
      <div class="analysis-section" id="resultContent"></div>
      <div style="display:flex;gap:8px;margin-top:var(--spacing-md);">
        <button class="export-btn" onclick="copyAnalysis()" style="background:#673ab7;">ğŸ“‹ åˆ†æçµæœã‚’ã‚³ãƒ”ãƒ¼</button>
        <button class="export-btn" onclick="runAIAnalysis()" style="background:#ff9800;">ğŸ”„ å†åˆ†æã™ã‚‹</button>
      </div>
    </div>
  </div>

  <nav class="nav-bottom">
    <a href="09-life-manual.html" class="btn btn-secondary">â† å‰ã¸</a>
    <a href="../index.html" class="btn btn-primary">ç›®æ¬¡ã¸æˆ»ã‚‹</a>
  </nav>
  <div class="toast" id="toast"></div>

  <!-- Lark APIé€£æº -->
  <script src="../js/lark-api.js"></script>
  <script src="../js/lark-config.js"></script>
  <script src="../js/data-sync.js"></script>

  <script>
    // ãƒ‡ãƒ¼ã‚¿çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
    function checkDataStatus() {
      const pages = ['personality', 'values', 'talent', 'passion', 'mission', 'life-manual'];

      pages.forEach(page => {
        const data = localStorage.getItem(`selfUnderstanding_${page}`);
        const statusEl = document.getElementById(`status-${page}`);
        if (data) {
          statusEl.textContent = 'âœ… å…¥åŠ›æ¸ˆã¿';
          statusEl.classList.add('complete');
        } else {
          statusEl.textContent = 'âŒ æœªå…¥åŠ›';
          statusEl.classList.add('incomplete');
        }
      });
    }

    // ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    function getAllData() {
      const data = {};
      const keys = ['personality', 'values', 'talent', 'passion', 'mission', 'life-manual'];

      keys.forEach(key => {
        const stored = localStorage.getItem(`selfUnderstanding_${key}`);
        if (stored) {
          data[key] = JSON.parse(stored);
        }
      });

      data.userName = localStorage.getItem('selfUnderstanding_userName') || 'åŒ¿å';
      return data;
    }

    // åˆ†æç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
    function generatePrompt() {
      const data = getAllData();

      let prompt = `# è‡ªå·±ç†è§£ãƒ¯ãƒ¼ã‚¯ åˆ†æä¾é ¼\n\n`;
      prompt += `ãƒ¦ãƒ¼ã‚¶ãƒ¼å: ${data.userName}\n\n`;

      // æ€§æ ¼è¨ºæ–­
      if (data.personality) {
        prompt += `## æ€§æ ¼è¨ºæ–­çµæœ\n`;
        prompt += `- ã‚¿ã‚¤ãƒ—: ${data.personality.resultType || 'æœªè¨ºæ–­'}\n`;
        prompt += `- ã†ã•ãï¼ˆçŸ­æœŸé›†ä¸­å‹ï¼‰: ${data.personality.scores?.usagi || 0}ç‚¹\n`;
        prompt += `- ã‹ã‚ï¼ˆé•·æœŸåˆ†æ•£å‹ï¼‰: ${data.personality.scores?.kame || 0}ç‚¹\n`;
        prompt += `- ã‚­ãƒªã‚®ãƒªã‚¹ï¼ˆå¿«æ¥½è¿½æ±‚å‹ï¼‰: ${data.personality.scores?.kirigirisu || 0}ç‚¹\n`;
        prompt += `- ã‚¢ãƒªï¼ˆãƒªã‚¹ã‚¯å›é¿å‹ï¼‰: ${data.personality.scores?.ari || 0}ç‚¹\n\n`;
      }

      // ä¾¡å€¤è¦³
      if (data.values) {
        prompt += `## ä¾¡å€¤è¦³ãƒ¯ãƒ¼ã‚¯\n`;
        prompt += `### æº€ãŸã•ã‚ŒãŸä½“é¨“\n${data.values.q1 || 'æœªå…¥åŠ›'}\n\n`;
        prompt += `### ã‚¤ãƒ©ã£ã¨ã—ãŸä½“é¨“\n${data.values.q2 || 'æœªå…¥åŠ›'}\n\n`;
        prompt += `### é¸ã‚“ã ä¾¡å€¤è¦³\n${data.values.q8?.selected?.join(', ') || 'æœªé¸æŠ'}\n\n`;
        prompt += `### ä¾¡å€¤è¦³ã®èª¬æ˜æ›¸\n${data.values.summary || 'æœªå…¥åŠ›'}\n\n`;
      }

      // æ‰èƒ½
      if (data.talent) {
        prompt += `## æ‰èƒ½ãƒ¯ãƒ¼ã‚¯\n`;
        prompt += `### æ„Ÿè¬ã•ã‚ŒãŸä½“é¨“\n${data.talent.q1 || 'æœªå…¥åŠ›'}\n\n`;
        prompt += `### é¸ã‚“ã æ‰èƒ½\n${data.talent.q7?.join(', ') || 'æœªé¸æŠ'}\n\n`;
        prompt += `### æ‰èƒ½ã®å„ªå…ˆé †ä½\n${data.talent.q8 || 'æœªå…¥åŠ›'}\n\n`;
        prompt += `### æ‰èƒ½ã®èª¬æ˜æ›¸\n${data.talent.q9 || 'æœªå…¥åŠ›'}\n\n`;
      }

      // æƒ…ç†±
      if (data.passion) {
        prompt += `## æƒ…ç†±ãƒ¯ãƒ¼ã‚¯\n`;
        prompt += `### ã¤ã„è¦‹ã¦ã—ã¾ã†ã‚³ãƒ³ãƒ†ãƒ³ãƒ„\n${data.passion.q1 || 'æœªå…¥åŠ›'}\n\n`;
        prompt += `### æ™‚é–“ã‚’å¿˜ã‚Œã‚‹è©±é¡Œ\n${data.passion.q2 || 'æœªå…¥åŠ›'}\n\n`;
        prompt += `### æƒ…ç†±ãƒã‚§ãƒƒã‚¯çµæœ: ${data.passion.q7?.filter(a => a === 'yes').length || 0}/10 YES\n\n`;
        prompt += `### æƒ…ç†±ã‚’ä¸€è¨€ã§\n${data.passion.q11 || 'æœªå…¥åŠ›'}\n\n`;
      }

      // ä½¿å‘½
      if (data.mission) {
        prompt += `## ä½¿å‘½ãƒ»åˆ¤æ–­è»¸ãƒ¯ãƒ¼ã‚¯\n`;
        prompt += `### è‡ªåˆ†ã‚‰ã—ã•ãƒ¯ãƒ¼ãƒ‰\n${data.mission.coreWords || 'æœªå…¥åŠ›'}\n\n`;
        prompt += `### äººç”Ÿã®ç›®çš„\n${data.mission.lifePurpose || 'æœªå…¥åŠ›'}\n\n`;
        prompt += `### äººç”Ÿã®ä½¿å‘½\n${data.mission.lifeMission || 'æœªå…¥åŠ›'}\n\n`;
        prompt += `### äººç”Ÿã®åˆ¤æ–­è»¸\n${data.mission.lifeCompass || 'æœªå…¥åŠ›'}\n\n`;
      }

      // äººç”Ÿã®èª¬æ˜æ›¸
      if (data['life-manual']) {
        prompt += `## äººç”Ÿã®èª¬æ˜æ›¸\n`;
        prompt += `${data['life-manual'].finalManual || 'æœªå…¥åŠ›'}\n\n`;
      }

      prompt += `---\n\n`;
      prompt += `ä¸Šè¨˜ã®è‡ªå·±ç†è§£ãƒ¯ãƒ¼ã‚¯ã®çµæœã‚’åˆ†æã—ã¦ã€ä»¥ä¸‹ã«ã¤ã„ã¦ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ï¼š\n`;
      prompt += `1. ã“ã®äººã®å¼·ã¿ã¨ç‰¹å¾´ã®ã¾ã¨ã‚\n`;
      prompt += `2. SNSç™ºä¿¡ã§æ´»ã‹ã›ã‚‹ãƒ†ãƒ¼ãƒã‚„åˆ‡ã‚Šå£\n`;
      prompt += `3. å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹åŒ–ã™ã‚‹ãªã‚‰ã©ã‚“ãªå½¢ãŒåˆã„ãã†ã‹\n`;
      prompt += `4. ä»Šå¾Œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³ã®ææ¡ˆ\n`;

      document.getElementById('promptText').textContent = prompt;
      document.getElementById('promptBox').style.display = 'block';
      showToast('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
    }

    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼
    function copyPrompt() {
      const text = document.getElementById('promptText').textContent;
      navigator.clipboard.writeText(text).then(() => {
        showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼', 'success');
      });
    }

    // JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    function exportJSON() {
      const data = getAllData();
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `self-understanding-${new Date().toISOString().split('T')[0]}.json`;
      a.click();

      URL.revokeObjectURL(url);
      showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
    }

    // ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
    function clearAllData() {
      if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        const keys = ['personality', 'values', 'talent', 'passion', 'mission', 'life-manual', 'userName'];
        keys.forEach(key => {
          localStorage.removeItem(`selfUnderstanding_${key}`);
        });
        checkDataStatus();
        showToast('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'success');
      }
    }

    // === AIåˆ†æã‚’å®Ÿè¡Œ ===
    async function runAIAnalysis() {
      const userData = getAllData();
      const dataKeys = ['personality', 'values', 'talent', 'passion', 'mission', 'life-manual'];
      const hasData = dataKeys.some(k => userData[k]);

      if (!hasData) {
        showToast('ãƒ¯ãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ¯ãƒ¼ã‚¯ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
      }

      const btn = document.getElementById('aiAnalyzeBtn');
      const loading = document.getElementById('analysisLoading');
      const result = document.getElementById('analysisResult');

      btn.disabled = true;
      btn.style.display = 'none';
      loading.style.display = 'block';
      result.classList.remove('show');

      try {
        // ç®¡ç†ç”»é¢ã§è¨­å®šã—ãŸã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã‚ã‚Œã°ä½¿ã†
        const customPrompt = localStorage.getItem('selfUnderstanding_adminPrompt') || undefined;

        const response = await fetch('/api/ai-analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userData, customPrompt })
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'AIåˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        const data = await response.json();
        document.getElementById('resultContent').innerHTML = markdownToHtml(data.analysis);
        result.classList.add('show');

        // åˆ†æçµæœã‚’localStorageã«ä¿å­˜
        localStorage.setItem('selfUnderstanding_aiAnalysis', JSON.stringify({
          analysis: data.analysis,
          timestamp: new Date().toISOString()
        }));

        showToast('åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸ!', 'success');

      } catch (error) {
        console.error('AI analysis error:', error);
        showToast(error.message || 'AIåˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
      } finally {
        btn.disabled = false;
        btn.style.display = 'block';
        loading.style.display = 'none';
      }
    }

    // åˆ†æçµæœã‚’ã‚³ãƒ”ãƒ¼
    function copyAnalysis() {
      const saved = localStorage.getItem('selfUnderstanding_aiAnalysis');
      if (saved) {
        const { analysis } = JSON.parse(saved);
        navigator.clipboard.writeText(analysis).then(() => showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ!', 'success'));
      }
    }

    // ç°¡æ˜“ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ â†’ HTMLå¤‰æ›
    function markdownToHtml(md) {
      if (!md) return '';
      let html = md
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        // è¦‹å‡ºã—
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^# (.+)$/gm, '<h1>$1</h1>')
        // å¤ªå­—ãƒ»æ–œä½“
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        // æ°´å¹³ç·š
        .replace(/^---$/gm, '<hr>')
        // å¼•ç”¨
        .replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>')
        // ãƒªã‚¹ãƒˆ
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>');

      // <li>ã®é€£ç¶šã‚’ul/olã§å›²ã‚€
      html = html.replace(/((<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
      // æ®‹ã‚Šã®è¡Œã‚’<p>ã§å›²ã‚€ï¼ˆç©ºè¡ŒåŒºåˆ‡ã‚Šï¼‰
      html = html.split('\n\n').map(block => {
        block = block.trim();
        if (!block) return '';
        if (block.startsWith('<h') || block.startsWith('<ul') || block.startsWith('<ol') || block.startsWith('<hr') || block.startsWith('<blockquote')) return block;
        return '<p>' + block.replace(/\n/g, '<br>') + '</p>';
      }).join('\n');

      return html;
    }

    // ä¿å­˜æ¸ˆã¿åˆ†æçµæœã‚’è¡¨ç¤º
    function loadSavedAnalysis() {
      const saved = localStorage.getItem('selfUnderstanding_aiAnalysis');
      if (saved) {
        const { analysis } = JSON.parse(saved);
        document.getElementById('resultContent').innerHTML = markdownToHtml(analysis);
        document.getElementById('analysisResult').classList.add('show');
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast ' + type + ' show';
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    document.addEventListener('DOMContentLoaded', () => {
      checkDataStatus();
      loadSavedAnalysis();
    });
  </script>
</body>
</html>
