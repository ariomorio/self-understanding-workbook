<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>人生の説明書 | マイコンパス</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .life-header {
      background: linear-gradient(135deg, #4caf50, #81c784);
      padding: var(--spacing-lg);
      border-radius: var(--radius-lg);
      text-align: center;
      color: var(--white);
      margin-bottom: var(--spacing-lg);
    }
    .life-header .emoji { font-size: 3rem; margin-bottom: var(--spacing-sm); }
    .prep-section {
      background: #fff3e0;
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-lg);
      border-left: 4px solid #ff9800;
    }
    .prep-section h3 { color: #e65100; margin-bottom: var(--spacing-sm); }
    .prep-section ol { padding-left: var(--spacing-md); }
    .prep-section li { margin-bottom: var(--spacing-sm); }

    /* 貼り付けエリア */
    .paste-area {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }
    .paste-area h3 {
      color: var(--primary-brown);
      margin-bottom: var(--spacing-sm);
    }
    .paste-textarea {
      width: 100%; min-height: 300px; padding: var(--spacing-md);
      border: 2px dashed #c8e6c9; border-radius: var(--radius-md);
      font-family: var(--font-family); font-size: 0.95rem;
      line-height: 1.8; resize: vertical; background: #f9fff9;
      transition: border-color 0.2s;
    }
    .paste-textarea:focus {
      outline: none; border-color: #4caf50; border-style: solid;
      box-shadow: 0 0 0 3px rgba(76,175,80,0.15);
    }
    .paste-textarea::placeholder { color: #aaa; }
    .btn-parse {
      display: block; width: 100%; margin-top: var(--spacing-md);
      padding: 14px; background: linear-gradient(135deg, #4caf50, #66bb6a);
      color: white; border: none; border-radius: var(--radius-md);
      font-size: 1.1rem; font-weight: bold; cursor: pointer;
      transition: all 0.2s; box-shadow: var(--shadow-sm);
    }
    .btn-parse:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .btn-parse:active { transform: translateY(0); }

    /* パース結果プレビュー */
    .parsed-result { display: none; }
    .parsed-result.show { display: block; }
    .parsed-item {
      background: var(--white);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      box-shadow: var(--shadow-sm);
      border-left: 4px solid var(--primary-green);
    }
    .parsed-item h4 {
      color: #2e7d32;
      margin-bottom: var(--spacing-xs);
      display: flex; align-items: center; gap: var(--spacing-sm);
    }
    .parsed-item .num {
      width: 28px; height: 28px;
      background: var(--primary-green);
      color: var(--white);
      border-radius: var(--radius-full);
      display: flex; align-items: center; justify-content: center;
      font-size: 0.85rem; font-weight: bold; flex-shrink: 0;
    }
    .parsed-item .item-content {
      white-space: pre-wrap; line-height: 1.8;
      color: var(--text-dark); font-size: 0.95rem;
      padding: var(--spacing-sm); background: #fafff8;
      border-radius: var(--radius-sm); margin-top: var(--spacing-xs);
    }
    .parsed-item textarea {
      width: 100%; min-height: 120px; padding: var(--spacing-sm);
      border: 1px solid #e0e0e0; border-radius: var(--radius-sm);
      font-family: var(--font-family); font-size: 0.95rem;
      line-height: 1.8; resize: vertical; display: none;
    }
    .parsed-item.editing .item-content { display: none; }
    .parsed-item.editing textarea { display: block; }
    .edit-toggle {
      margin-left: auto; background: none; border: 1px solid #ccc;
      border-radius: 6px; padding: 2px 10px; font-size: 0.8rem;
      color: var(--text-light); cursor: pointer;
    }
    .edit-toggle:hover { background: #f5f5f5; }

    /* YOUとはカード */
    .you-card {
      background: linear-gradient(135deg, #c8e6c9, #a5d6a7);
      padding: var(--spacing-lg);
      border-radius: var(--radius-lg);
      margin-top: var(--spacing-md);
      text-align: center;
    }
    .you-card h3 { color: #2e7d32; margin-bottom: var(--spacing-sm); }
    .you-card .you-text {
      font-size: 1.2rem; font-weight: bold; color: #1b5e20;
      padding: var(--spacing-md); background: rgba(255,255,255,0.7);
      border-radius: var(--radius-md); line-height: 1.8;
    }

    /* 保存インジケータ */
    .save-indicator {
      position: fixed; bottom: 80px; right: 16px;
      background: var(--primary-green); color: white;
      padding: 8px 16px; border-radius: 20px;
      font-size: 0.85rem; box-shadow: var(--shadow-md);
      opacity: 0; transition: opacity 0.3s; pointer-events: none;
      z-index: 100;
    }
    .save-indicator.show { opacity: 1; }
  </style>
</head>
<body>
  <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>

  <header class="page-header" style="background: linear-gradient(135deg, #4caf50, #81c784);">
    <h1><span class="icon">&#x1F331;</span> あなたの人生の説明書</h1>
  </header>

  <div class="container">
    <div class="video-section">
      <h3>&#x1F4FA; 解説動画</h3>
      <div class="video-embed">
        <iframe src="https://drive.google.com/file/d/1OcUi0au5ZOg5q8q5KdmBt5WwWlY991FR/preview" allow="autoplay" allowfullscreen></iframe>
      </div>
      <div class="video-fallback">
        <a href="https://drive.google.com/file/d/1OcUi0au5ZOg5q8q5KdmBt5WwWlY991FR/view" target="_blank">動画が表示されない場合はこちら</a>
      </div>
    </div>

    <div class="life-header">
      <div class="emoji">&#x1F331;</div>
      <h2>すべてのワークを統合して<br>あなただけの「人生の説明書」を作ろう</h2>
    </div>

    <div class="prep-section">
      <h3>&#x1F4CB; 事前準備</h3>
      <ol>
        <li><strong>「価値観・才能・情熱・使命/判断軸」のワークシート</strong>をそれぞれPDFやスクショで保存して、まとめておさるAIにアップロードしてください</li>
        <li><strong>なりたい自分ワークの「5年後〜半年後の目標と理由」</strong>もまとめておさるAIにアップロードしてください</li>
        <li><strong>性格診断の結果</strong>もおさるAIにアップロードしてください</li>
        <li><strong>おさるAIに、テンプレートを読み込ませて作成してもらってください</strong></li>
      </ol>
    </div>

    <!-- 一括貼り付けエリア -->
    <div class="paste-area" id="pasteArea">
      <h3>&#x1F4DD; おさるAIの出力を貼り付け</h3>
      <p style="color:var(--text-light); margin-bottom:var(--spacing-sm); font-size:0.9rem;">おさるAIで作成した人生の説明書（13項目 + YOUとは）をまるごとコピーして貼り付けてください</p>
      <textarea class="paste-textarea" id="pasteInput" placeholder="&#x2460; わたしの特徴・性格

→ 自分をひとことで言うと？

...

&#x2461; わたしの強み・才能（〇〇する力）

...

（おさるAIの出力をまるごと貼り付けてください）"></textarea>
      <button class="btn-parse" id="btnParse" onclick="parseAndApply()">&#x2728; 貼り付けた内容を反映する</button>
    </div>

    <!-- パース結果プレビュー -->
    <div class="parsed-result" id="parsedResult">
      <h2 class="section-title" style="color:#2e7d32;">&#x2705; あなたの人生の説明書</h2>
      <p style="color:var(--text-light); margin-bottom:var(--spacing-md); font-size:0.9rem;">内容を確認してください。各項目の「編集」ボタンで修正もできます。</p>

      <div id="parsedItems"></div>

      <!-- YOUとは -->
      <div class="you-card" id="youCard" style="display:none;">
        <h3>YOUとは</h3>
        <div class="you-text" id="youText"></div>
      </div>

      <div style="background: var(--light-green); padding: var(--spacing-lg); border-radius: var(--radius-md); margin-top: var(--spacing-lg); text-align: center;">
        <p style="font-size: 1.2rem; color: #2e7d32; margin-bottom: var(--spacing-md);">
          <strong>&#x1F389; おめでとうございます！</strong>
        </p>
        <p>この「わたしの人生の説明書」は、<br>あなたの人生の選択に迷ったとき、自分を信じて進むための<strong>"心のコンパス"</strong>になります&#x1F9ED;</p>
        <p style="margin-top: var(--spacing-md);">定期的に見返すことで、"成長した自分"とも再会できます。</p>
        <p style="margin-top: var(--spacing-md); font-size: 1.1rem;"><strong>大丈夫。あなたは、あなたでいい&#x1F331;</strong><br>あなたらしい人生を、心から応援しています！</p>
      </div>

      <button class="btn-parse" style="margin-top:var(--spacing-lg); background:linear-gradient(135deg,#ff9800,#ffb74d);" onclick="showPasteArea()">&#x1F504; 貼り直す</button>
    </div>
  </div>

  <div class="save-indicator" id="saveIndicator">&#x2714; 保存しました</div>

  <nav class="nav-bottom">
    <a href="10-ai-analysis.html" class="btn btn-secondary">&#x2190; 前へ</a>
    <a href="../index.html" class="btn btn-home">目次に戻る</a>
    <button class="btn btn-save" id="btnSave" onclick="saveData()">保存する</button>
  </nav>
  <div class="toast" id="toast"></div>

  <script src="../js/lark-api.js"></script>
  <script src="../js/lark-config.js"></script>
  <script src="../js/data-sync.js"></script>
  <script src="../js/save-helper.js"></script>

  <script>
    var ITEM_TITLES = [
      '',
      '\u308f\u305f\u3057\u306e\u7279\u5fb4\u30fb\u6027\u683c',
      '\u308f\u305f\u3057\u306e\u5f37\u307f\u30fb\u624d\u80fd\uff08\u3007\u3007\u3059\u308b\u529b\uff09',
      '\u8ab2\u984c\u30fb\u3064\u307e\u305a\u304d\u30dd\u30a4\u30f3\u30c8',
      '\u3084\u308b\u6c17\u304c\u306a\u304f\u306a\u308b\u30c8\u30ea\u30ac\u30fc & \u5fa9\u6d3b\u30b9\u30a4\u30c3\u30c1',
      '\u5927\u5207\u306b\u3057\u305f\u3044\u4fa1\u5024\u89b3 TOP5',
      '\u60c5\u71b1\u3092\u611f\u3058\u308b\u30c6\u30fc\u30de\u30fb\u5206\u91ce',
      '\u81ea\u5206\u306b\u5408\u3046\u50cd\u304d\u65b9\u30fb\u74b0\u5883',
      '\u76ee\u6307\u3057\u305f\u3044\u201c\u751f\u304d\u65b9\u201d',
      '\u767a\u4fe1\u30c6\u30fc\u30de\u306b\u3059\u308b\u306a\u3089\uff1f',
      '\u8ab0\u306b\u5c4a\u3051\u305f\u3044\uff1f',
      '\u7406\u60f3\u306e\u30d5\u30a9\u30ed\u30ef\u30fc\u306e\u60a9\u307f',
      '\u5c4a\u3051\u3089\u308c\u308b\u4fa1\u5024\u30fb\u5909\u5316',
      '\u5546\u54c1\u30fb\u30b5\u30fc\u30d3\u30b9\u306b\u3059\u308b\u306a\u3089\uff1f'
    ];

    var CIRCLED_NUMS = ['', '\u2460', '\u2461', '\u2462', '\u2463', '\u2464', '\u2465', '\u2466', '\u2467', '\u2468', '\u2469', '\u246A', '\u246B', '\u246C'];

    var parsedData = {};

    // おさるAI出力をパース
    function parseAIOutput(text) {
      var result = {};

      // 各丸数字の位置を検出
      var positions = [];
      for (var i = 1; i <= 13; i++) {
        var patterns = [CIRCLED_NUMS[i], '(' + i + ')', i + '.', i + '\uff09'];
        for (var p = 0; p < patterns.length; p++) {
          var idx = text.indexOf(patterns[p]);
          if (idx !== -1) {
            var existing = null;
            for (var k = 0; k < positions.length; k++) {
              if (positions[k].num === i) { existing = positions[k]; break; }
            }
            if (!existing || idx < existing.pos) {
              if (existing) {
                positions = positions.filter(function(x) { return x.num !== i; });
              }
              positions.push({ num: i, pos: idx, pat: patterns[p] });
            }
          }
        }
      }

      positions.sort(function(a, b) { return a.pos - b.pos; });

      // YOUとはの位置を検出（セクション区切りとして使用）
      var youIdx = -1;
      var youPatterns = ['YOU\u3068\u306f', 'you\u3068\u306f'];
      for (var y = 0; y < youPatterns.length; y++) {
        var yi = text.lastIndexOf(youPatterns[y]);
        if (yi !== -1 && (youIdx === -1 || yi > youIdx)) youIdx = yi;
      }

      // 各セクションのテキストを抽出
      for (var j = 0; j < positions.length; j++) {
        var current = positions[j];
        var startPos = current.pos + current.pat.length;

        var endPos;
        if (j + 1 < positions.length) {
          endPos = positions[j + 1].pos;
        } else if (youIdx !== -1 && youIdx > startPos) {
          // 13番目の後にYOUとはがある場合
          // "13項目まとめコピー"や"YOUの13項目まとめ"の行を除外
          var afterLast = text.substring(startPos, youIdx);
          var summaryIdx = afterLast.search(/YOU\u306e13\u9805\u76ee|\u307e\u3068\u3081\u30b3\u30d4\u30fc/);
          endPos = summaryIdx !== -1 ? startPos + summaryIdx : youIdx;
        } else {
          endPos = youIdx !== -1 ? youIdx : text.length;
        }

        var sectionText = text.substring(startPos, endPos).trim();

        // 最初の行がタイトル行なら除去
        var lines = sectionText.split('\n');
        if (lines.length > 0) {
          var firstLine = lines[0].trim();
          // タイトルキーワードを含む行を除去
          var titleKeywords = ['\u7279\u5fb4', '\u5f37\u307f', '\u8ab2\u984c', '\u3084\u308b\u6c17', '\u4fa1\u5024\u89b3', '\u60c5\u71b1', '\u50cd\u304d\u65b9', '\u751f\u304d\u65b9', '\u767a\u4fe1', '\u5c4a\u3051\u305f\u3044', '\u60a9\u307f', '\u4fa1\u5024\u30fb\u5909\u5316', '\u5546\u54c1', '\u30b5\u30fc\u30d3\u30b9'];
          var isTitle = false;
          for (var t = 0; t < titleKeywords.length; t++) {
            if (firstLine.indexOf(titleKeywords[t]) !== -1) { isTitle = true; break; }
          }
          if (isTitle) {
            lines.shift();
            sectionText = lines.join('\n').trim();
          }
        }

        result['item' + current.num] = sectionText;
      }

      // YOUとは を抽出
      if (youIdx !== -1) {
        var afterYou = text.substring(youIdx + 4).trim(); // "YOUとは" = 4 chars
        // 「」で囲まれた部分を探す
        var quoteMatch = afterYou.match(/[\u300c\u201c]([^\u300d\u201d]+)[\u300d\u201d]/);
        if (quoteMatch) {
          result.finalManual = quoteMatch[1];
        } else {
          // 最初の非空行を取得
          var youLines = afterYou.split('\n');
          for (var yl = 0; yl < youLines.length; yl++) {
            var line = youLines[yl].trim();
            if (line && line !== 'YOU\u3068\u306f') {
              result.finalManual = line.replace(/^[\u300c\u201c\s]+|[\u300d\u201d\s]+$/g, '');
              break;
            }
          }
        }
      }

      return result;
    }

    // パース実行
    function parseAndApply() {
      var input = document.getElementById('pasteInput').value.trim();
      if (!input) {
        showToast('\u30c6\u30ad\u30b9\u30c8\u3092\u8cbc\u308a\u4ed8\u3051\u3066\u304f\u3060\u3055\u3044', 'error');
        return;
      }

      parsedData = parseAIOutput(input);

      var filledCount = 0;
      for (var i = 1; i <= 13; i++) {
        if (parsedData['item' + i]) filledCount++;
      }

      if (filledCount === 0) {
        showToast('\u2460\u301c\u246C \u306e\u9805\u76ee\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3067\u3057\u305f', 'error');
        return;
      }

      renderParsedItems();
      document.getElementById('pasteArea').style.display = 'none';
      document.getElementById('parsedResult').classList.add('show');
      saveDataSilent();
      showToast(filledCount + '\u9805\u76ee\u3092\u53cd\u6620\u3057\u307e\u3057\u305f\uff01', 'success');
    }

    // パース結果を描画
    function renderParsedItems() {
      var container = document.getElementById('parsedItems');
      container.innerHTML = '';

      for (var i = 1; i <= 13; i++) {
        var content = parsedData['item' + i] || '';
        var div = document.createElement('div');
        div.className = 'parsed-item';
        div.id = 'parsed-item-' + i;

        var h4 = document.createElement('h4');
        var numSpan = document.createElement('span');
        numSpan.className = 'num';
        numSpan.textContent = i;
        h4.appendChild(numSpan);
        h4.appendChild(document.createTextNode(' ' + ITEM_TITLES[i]));
        var btn = document.createElement('button');
        btn.className = 'edit-toggle';
        btn.textContent = '\u7de8\u96c6';
        btn.setAttribute('data-num', String(i));
        btn.onclick = function() { toggleEdit(parseInt(this.getAttribute('data-num'))); };
        h4.appendChild(btn);

        var contentDiv = document.createElement('div');
        contentDiv.className = 'item-content';
        contentDiv.innerHTML = escHtml(content);

        var textarea = document.createElement('textarea');
        textarea.id = 'edit-item-' + i;
        textarea.value = content;

        div.appendChild(h4);
        div.appendChild(contentDiv);
        div.appendChild(textarea);
        container.appendChild(div);
      }

      // YOUとは
      if (parsedData.finalManual) {
        document.getElementById('youCard').style.display = 'block';
        document.getElementById('youText').textContent = parsedData.finalManual;
      } else {
        document.getElementById('youCard').style.display = 'none';
      }

      updateProgress();
    }

    function toggleEdit(num) {
      var item = document.getElementById('parsed-item-' + num);
      var textarea = document.getElementById('edit-item-' + num);
      var btn = item.querySelector('.edit-toggle');

      if (item.classList.contains('editing')) {
        parsedData['item' + num] = textarea.value;
        item.querySelector('.item-content').innerHTML = escHtml(textarea.value);
        item.classList.remove('editing');
        btn.textContent = '\u7de8\u96c6';
        saveDataSilent();
      } else {
        textarea.value = parsedData['item' + num] || '';
        item.classList.add('editing');
        btn.textContent = '\u78ba\u5b9a';
        textarea.focus();
      }
    }

    function showPasteArea() {
      document.getElementById('pasteArea').style.display = 'block';
      document.getElementById('parsedResult').classList.remove('show');
    }

    function saveData() {
      collectDataFromUI();
      doSave();
      showToast('\u4fdd\u5b58\u3057\u307e\u3057\u305f\uff01', 'success');
      showSaveIndicator();
    }

    function saveDataSilent() {
      collectDataFromUI();
      doSave();
    }

    function doSave() {
      var data = {};
      for (var i = 1; i <= 13; i++) {
        data['item' + i] = parsedData['item' + i] || '';
      }
      data.finalManual = parsedData.finalManual || '';
      data.rawInput = document.getElementById('pasteInput').value;
      data.timestamp = new Date().toISOString();

      localStorage.setItem('selfUnderstanding_life-manual', JSON.stringify(data));

      if (window.DataSync) {
        window.DataSync.saveWorkData('life-manual', data).catch(function(e) {
          console.error('Lark sync failed:', e);
        });
      }
    }

    function collectDataFromUI() {
      for (var i = 1; i <= 13; i++) {
        var textarea = document.getElementById('edit-item-' + i);
        if (textarea) parsedData['item' + i] = textarea.value;
      }
    }

    function loadData() {
      var saved = localStorage.getItem('selfUnderstanding_life-manual');
      if (!saved) return;
      try {
        var data = JSON.parse(saved);
        var hasItems = false;
        for (var i = 1; i <= 13; i++) {
          if (data['item' + i]) {
            parsedData['item' + i] = data['item' + i];
            hasItems = true;
          }
        }
        parsedData.finalManual = data.finalManual || '';
        if (data.rawInput) {
          document.getElementById('pasteInput').value = data.rawInput;
        }
        if (hasItems) {
          renderParsedItems();
          document.getElementById('pasteArea').style.display = 'none';
          document.getElementById('parsedResult').classList.add('show');
        }
        updateProgress();
      } catch(e) { console.error('Failed to load data:', e); }
    }

    function updateProgress() {
      var filled = 0;
      for (var i = 1; i <= 13; i++) {
        if (parsedData['item' + i]) filled++;
      }
      if (parsedData.finalManual) filled++;
      var progress = (filled / 14) * 100;
      document.getElementById('progressBar').style.width = progress + '%';
    }

    function showToast(message, type) {
      var toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast ' + (type || 'success') + ' show';
      setTimeout(function() { toast.classList.remove('show'); }, 3000);
    }

    function showSaveIndicator() {
      var el = document.getElementById('saveIndicator');
      el.classList.add('show');
      setTimeout(function() { el.classList.remove('show'); }, 1500);
    }

    function escHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
    }

    document.addEventListener('DOMContentLoaded', loadData);
  </script>
</body>
</html>
